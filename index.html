<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DINO Game v2 ‚Äî –ë–∏–∑–Ω–µ—Å, –ö—Ä–∏–ø—Ç–∞, –î–∏–Ω–æ–ù–µ—Ç</title>

  <!-- Icons & Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            darkBg: "#0f1117",
            darkBgLight: "#1a1d26",
            darkCard: "#1d212c",
            darkCardHover: "#232734",
            darkPrimary: "#10b981",
            darkPrimaryHover: "#059669",
            darkSecondary: "#facc15",
            darkDanger: "#ef4444",
            darkMuted: "#94a3b8",
            darkBorder: "#2d323d",
            lightBg: "#f0f4f8",
            lightBgLight: "#ffffff",
            lightCard: "#ffffff",
            lightCardHover: "#e5e7eb",
            lightPrimary: "#047857",
            lightPrimaryHover: "#03543f",
            lightSecondary: "#d97706",
            lightDanger: "#b91c1c",
            lightMuted: "#4b5563",
            lightBorder: "#d1d5db"
          },
          boxShadow: {
            dino: "0 10px 30px rgba(16,185,129,.15)",
            card: "0 8px 25px rgba(0,0,0,.3)",
            glow: "0 0 15px rgba(16,185,129,.3)"
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
            'bounce-subtle': 'bounce 1s infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      user-select: none;
    }

    body.dark {
      background-color: #0f1117;
      color: #f8fafc;
    }

    body.light {
      background-color: #f0f4f8;
      color: #1f2937;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #0f1117 0%, #1a1d26 100%);
    }

    .dino-gradient-text {
      background: linear-gradient(90deg, #10b981, #facc15);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-btn.active {
      color: #facc15;
      position: relative;
    }

    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: #facc15;
      border-radius: 3px;
    }

    .tab-btn.active {
      background: #10b981;
      color: #fff;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .dark .card {
      background: #1d212c;
      border: 1px solid #2d323d;
    }

    .light .card {
      background: #ffffff;
      border: 1px solid #d1d5db;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .dark .card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,.2);
      border-color: rgba(16,185,129,.2);
    }

    .light .card:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      border-color: rgba(16,185,129,.2);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .dark .pill {
      background: rgba(16,185,129,.15);
      color: #10b981;
    }

    .light .pill {
      background: rgba(16,185,129,.1);
      color: #047857;
    }

    .fade-in {
      animation: fadein 0.25s ease-out;
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .coin-pop {
      animation: coinPop 0.6s ease-out forwards;
    }

    .progress-bar {
      overflow: hidden;
      border-radius: 10px;
    }

    .dark .progress-bar {
      background: rgba(255, 255, 255, 0.1);
    }

    .light .progress-bar {
      background: rgba(0, 0, 0, 0.05);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes coinPop {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      50% { opacity: 0.8; transform: translateY(-30px) scale(1.1); }
      100% { opacity: 0; transform: translateY(-60px) scale(1); }
    }

    /* Mobile specific styles */
    @media (max-width: 767px) {
      .mobile-tab-content {
        padding-bottom: 80px;
      }

      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        backdrop-filter: blur(10px);
      }

      .dark .mobile-bottom-nav {
        background: rgba(29, 33, 44, 0.9);
        border-top: 1px solid #2d323d;
      }

      .light .mobile-bottom-nav {
        background: rgba(255, 255, 255, 0.9);
        border-top: 1px solid #d1d5db;
      }

      textarea {
        max-height: 100px;
        overflow-y: auto;
        word-break: break-word;
      }

      .post-text {
        overflow: hidden;
        max-height: 100px;
        text-overflow: ellipsis;
      }

      .post-expanded .post-text {
        max-height: none;
      }
    }
  </style>
</head>

<body class="gradient-bg min-h-screen dark"> <!-- Default dark theme -->
  <!-- Mobile Layout -->
  <div>
    <!-- Header -->
    <header class="glass p-4 sticky top-0 z-40 border-b border-darkBorder">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img id="mobile-avatar" src="https://i.pravatar.cc/150?img=10" class="w-10 h-10 rounded-full mr-3">
          <div>
            <div class="font-bold"><span id="mobile-username">DinoUser</span></div>
            <div class="text-xs text-darkMuted"><span id="mobile-balance">0</span> DINO</div>
            <div class="text-xs text-darkSecondary"><span id="mobile-stars">0</span> ‚≠ê</div>
            <div class="text-xs text-darkPrimary"><span id="mobile-ton">0</span> TON</div>
            <div class="text-xs text-darkMuted"><span id="mobile-dps">0</span>/—Å–µ–∫</div>
          </div>
        </div>
        <div class="flex items-center">
          <div class="mr-3 text-right">
            <div class="text-xs text-darkMuted">–£—Ä. <span id="mobile-level">1</span></div>
            <div class="text-xs text-darkPrimary" id="mobile-xp-text">0/150</div>
          </div>
          <div class="w-8 h-8 rounded-full bg-darkCard flex items-center justify-center">
            <i class="fa-regular fa-user text-sm"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main id="mobile-content" class="mobile-tab-content p-4 pb-20"></main>

    <!-- Bottom Navigation -->
    <nav class="mobile-bottom-nav p-2 grid grid-cols-5 gap-1">
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="clicker">
        <i class="fa-regular fa-hand-pointer text-lg mb-1"></i>
        <span class="text-xs">–ö–ª–∏–∫–µ—Ä</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="dinonet">
        <i class="fa-solid fa-globe text-lg mb-1"></i>
        <span class="text-xs">–î–∏–Ω–æ–ù–µ—Ç</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="business">
        <i class="fa-solid fa-building text-lg mb-1"></i>
        <span class="text-xs">–ë–∏–∑–Ω–µ—Å</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="investments">
        <i class="fa-solid fa-chart-line text-lg mb-1"></i>
        <span class="text-xs">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="profile">
        <i class="fa-regular fa-user text-lg mb-1"></i>
        <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
      </button>
    </nav>
  </div>

  <!-- Modals / notifications -->
  <div id="modal-root"></div>
  <div id="toast-root" class="fixed top-3 right-3 space-y-2 z-[999] max-w-xs"></div>

  <script>
  /*********************
   * Core Game State & API
   *********************/
  const VERSION = 6; // Updated version
  const LS_KEY = "dinogame_v6_state";
  const THEME_KEY = "dinogame_v6_theme";

  const API_BASE = 'https://dinod.ru/api';

  // Tunable economy constants
  const ECON = {
    CLICK_INC: 1.5,
    CLICK_COST_MULT: 1.6,
    COMPANY_CREATE_COST: 10000,
    CRYPTO_CREATE_DINO: 50000,
    CLIENT_COST: 3000,
    RELEASE_SHARES_COST: 1000, // for 100 shares = 10 per share? Adjust as per logic
    RELEASE_CRYPTO_COST: 5000, // for 100 crypto
  };

  const state = {
    version: VERSION,
    currentTab: "clicker",
    balance: 1000,
    dps: 0,
    stars: 100,
    ton: 1.0,
    perClick: 2,
    clickUpgradeCost: 200,
    user: {
      id: null,
      telegram_id: null,
      username: "DinoUser",
      first_name: "Dino",
      last_name: "Player",
      avatar_url: "https://i.pravatar.cc/150?img=10",
      bio: "–õ—é–±–∏—Ç–µ–ª—å –¥–∏–Ω–æ–∑–∞–≤—Ä–æ–≤ –∏ –∫–ª–∏–∫–µ—Ä–æ–≤.",
      telegram_channel: "",
      show_username: true
    },
    clicks: 0,
    level: 1,
    xp: 0,
    xpNext: 150,
    theme: "dark",
    lastTick: Date.now(),
    isGuest: false,
    saveInProgress: false,
    leaderboard: [],
    companies: [], // Owned companies
    cryptos: [], // Owned cryptos
    ownedShares: [], // {companyId, amount}
    ownedCryptos: [], // {cryptoId, amount, type: 'dino' or 'stars'}
    newPurchases: 0, // For wallet badge
    adminPayouts: [] // For admin panel
  };

  // Elements
  const $content = () => document.getElementById("mobile-content");
  const $balance = () => document.getElementById("mobile-balance");
  const $stars = () => document.getElementById("mobile-stars");
  const $ton = () => document.getElementById("mobile-ton");
  const $dps = () => document.getElementById("mobile-dps");
  const $level = () => document.getElementById("mobile-level");
  const $xpText = () => document.getElementById("mobile-xp-text");
  const $modal = () => document.getElementById("modal-root");
  const $toast = () => document.getElementById("toast-root");
  const $mobileUsername = () => document.getElementById("mobile-username");
  const $mobileAvatar = () => document.getElementById("mobile-avatar");
  const $walletBadge = () => document.getElementById("wallet-badge");

  /*********************
   * API Functions
   *********************/
  async function apiCall(endpoint, options = {}) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API call failed:', error);
      toast('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
      throw error;
    }
  }

  async function initUser() {
    try {
      let userData = {};

      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        userData = {
          telegram_id: tgUser.id,
          username: tgUser.username || 'DinoUser',
          first_name: tgUser.first_name || 'Dino',
          last_name: tgUser.last_name || '',
          avatar_url: tgUser.photo_url || "https://i.pravatar.cc/150?img=10",
          is_guest: false
        };
        state.isGuest = false;
      } else {
        userData = { is_guest: true };
        state.isGuest = true;
      }

      const result = await apiCall('/user', {
        method: 'POST',
        body: JSON.stringify(userData)
      });

      if (result.success) {
        updateStateFromUser(result.user);
        toast('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
        loadOwned();
        if (result.user.username === '@dopoldodo') loadAdminPayouts();
        return result.user;
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      console.error('Failed to initialize user:', error);
      state.isGuest = true;
      toast('–†–∞–±–æ—Ç–∞–µ–º –≤ –≥–æ—Å—Ç–µ–≤–æ–º —Ä–µ–∂–∏–º–µ', 'error');
      return null;
    }
  }

  function updateStateFromUser(user) {
    if (!user) return;

    state.user = { ...state.user, ...user };
    state.balance = user.balance || state.balance;
    state.stars = user.stars || state.stars;
    state.ton = user.ton || state.ton;
    state.perClick = user.per_click || state.perClick;
    state.clickUpgradeCost = user.click_upgrade_cost || state.clickUpgradeCost;
    state.level = user.level || state.level;
    state.xp = user.xp || state.xp;
    state.xpNext = user.xp_next || state.xpNext;
  }

  async function saveUserData() {
    if (state.isGuest || state.saveInProgress || !state.user.id) return;

    state.saveInProgress = true;

    try {
      const result = await apiCall(`/user/${state.user.id}`, {
        method: 'PUT',
        body: JSON.stringify({
          balance: state.balance,
          stars: state.stars,
          ton: state.ton,
          per_click: state.perClick,
          click_upgrade_cost: state.clickUpgradeCost,
          level: state.level,
          xp: state.xp,
          xp_next: state.xpNext
        })
      });

      if (!result.success) {
        console.error('Failed to save user data:', result.error);
      }
    } catch (error) {
      console.error('Error saving user data:', error);
    } finally {
      state.saveInProgress = false;
    }
  }

  async function saveUserProfile() {
    if (state.isGuest || !state.user.id) return;

    try {
      const result = await apiCall(`/user/${state.user.id}/profile`, {
        method: 'PUT',
        body: JSON.stringify({
          first_name: state.user.first_name,
          last_name: state.user.last_name,
          bio: state.user.bio,
          telegram_channel: state.user.telegram_channel,
          show_username: state.user.show_username,
          avatar_url: state.user.avatar_url
        })
      });

      if (result.success) {
        toast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!');
      }
    } catch (error) {
      console.error('Error saving profile:', error);
      toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
    }
  }

  async function loadLeaderboard(type = 'balance') {
    try {
      const result = await apiCall(`/leaderboard?type=${type}&limit=10`);
      if (result.success) {
        state.leaderboard = result.leaderboard;
        renderIfTab("dinonet", renderDinoNet);
      }
    } catch (error) {
      console.error('Error loading leaderboard:', error);
    }
  }

  async function loadOwned() {
    try {
      const result = await apiCall(`/user/${state.user.id}/owned`);
      if (result.success) {
        state.companies = result.companies;
        state.cryptos = result.cryptos;
        state.ownedShares = result.ownedShares;
        state.ownedCryptos = result.ownedCryptos;
      }
    } catch (error) {
      console.error('Error loading owned:', error);
    }
  }

  async function createCompany(name, tgChannelLink = '', tgChannelName = '') {
    if (state.balance < ECON.COMPANY_CREATE_COST) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO', 'error');
    try {
      const result = await apiCall('/company', {
        method: 'POST',
        body: JSON.stringify({
          name,
          tg_channel_link: tgChannelLink,
          tg_channel_name: tgChannelName
        })
      });
      if (result.success) {
        state.balance -= ECON.COMPANY_CREATE_COST;
        state.companies.push(result.company);
        toast('–ö–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
        renderBusiness();
        saveUserData();
      } else {
        toast(result.error, 'error');
      }
    } catch (error) {
      console.error('Error creating company:', error);
    }
  }

  async function createCrypto(name, type, tgChannelLink = '', tgChannelName = '') {
    if (type === 'dino') {
      if (state.balance < ECON.CRYPTO_CREATE_DINO) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO', 'error');
      try {
        const result = await apiCall('/crypto', {
          method: 'POST',
          body: JSON.stringify({
            name,
            created_with: 'dino',
            tg_channel_link: tgChannelLink,
            tg_channel_name: tgChannelName
          })
        });
        if (result.success) {
          state.balance -= ECON.CRYPTO_CREATE_DINO;
          state.cryptos.push(result.crypto);
          toast('–ö—Ä–∏–ø—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!');
          renderBusiness();
          saveUserData();
        } else {
          toast(result.error, 'error');
        }
      } catch (error) {
        console.error('Error creating crypto:', error);
      }
    } else if (type === 'stars') {
      // Open invoice for stars payment
      try {
        const invoiceResult = await apiCall('/crypto/invoice', {
          method: 'POST',
          body: JSON.stringify({
            name,
            created_with: 'stars',
            tg_channel_link: tgChannelLink,
            tg_channel_name: tgChannelName
          })
        });
        if (invoiceResult.success) {
          Telegram.WebApp.openInvoice(invoiceResult.invoice_url, (status) => {
            if (status === 'paid') {
              state.cryptos.push(invoiceResult.crypto);
              toast('–ö—Ä–∏–ø—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –∑–∞ –∑–≤—ë–∑–¥—ã!');
              renderBusiness();
            }
          });
        }
      } catch (error) {
        console.error('Error creating stars crypto:', error);
      }
    }
  }

  async function buyClient(companyId) {
    if (state.balance < ECON.CLIENT_COST) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO', 'error');
    try {
      const result = await apiCall(`/company/${companyId}/buy-client`, {
        method: 'POST'
      });
      if (result.success) {
        state.balance -= ECON.CLIENT_COST;
        // Update company clients
        const company = state.companies.find(c => c.id === companyId);
        if (company) company.clients_count++;
        toast('–ö–ª–∏–µ–Ω—Ç –∫—É–ø–ª–µ–Ω!');
        renderBusiness();
        saveUserData();
      }
    } catch (error) {
      console.error('Error buying client:', error);
    }
  }

  async function releaseShares(companyId) {
    if (state.balance < ECON.RELEASE_SHARES_COST) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO', 'error');
    try {
      const result = await apiCall(`/company/${companyId}/release-shares`, {
        method: 'POST'
      });
      if (result.success) {
        state.balance -= ECON.RELEASE_SHARES_COST;
        const company = state.companies.find(c => c.id === companyId);
        if (company) company.shares_available += 100; // Assume 100 per release
        toast('–ê–∫—Ü–∏–∏ –≤—ã–ø—É—â–µ–Ω—ã!');
        renderBusiness();
        saveUserData();
      }
    } catch (error) {
      console.error('Error releasing shares:', error);
    }
  }

  async function buyShare(companyId, amount = 1) {
    try {
      const result = await apiCall(`/company/${companyId}/buy-share`, {
        method: 'POST',
        body: JSON.stringify({ amount })
      });
      if (result.success) {
        state.balance -= result.total_cost;
        state.ownedShares.push({ companyId, amount });
        state.newPurchases += amount;
        updateWalletBadge();
        toast('–ê–∫—Ü–∏–∏ –∫—É–ø–ª–µ–Ω—ã!');
        renderInvestments();
        saveUserData();
      } else {
        toast(result.error, 'error');
      }
    } catch (error) {
      console.error('Error buying share:', error);
    }
  }

  async function sellShare(companyId, amount = 1) {
    try {
      const result = await apiCall(`/company/${companyId}/sell-share`, {
        method: 'POST',
        body: JSON.stringify({ amount })
      });
      if (result.success) {
        state.balance += result.total_return;
        // Remove from ownedShares
        const index = state.ownedShares.findIndex(s => s.companyId === companyId);
        if (index > -1) {
          state.ownedShares[index].amount -= amount;
          if (state.ownedShares[index].amount <= 0) state.ownedShares.splice(index, 1);
        }
        toast('–ê–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–Ω—ã!');
        renderInvestments();
        saveUserData();
      } else {
        toast(result.error, 'error');
      }
    } catch (error) {
      console.error('Error selling share:', error);
    }
  }

  async function buyCrypto(cryptoId, amount = 1) {
    const crypto = state.marketCryptos.find(c => c.id === cryptoId); // Assume loaded market
    if (crypto.created_with === 'stars') {
      try {
        const invoiceResult = await apiCall(`/crypto/${cryptoId}/invoice`, {
          method: 'POST',
          body: JSON.stringify({ amount })
        });
        if (invoiceResult.success) {
          Telegram.WebApp.openInvoice(invoiceResult.invoice_url, (status) => {
            if (status === 'paid') {
              state.ownedCryptos.push({ cryptoId, amount, type: 'stars' });
              state.newPurchases += amount;
              updateWalletBadge();
              toast('–ö—Ä–∏–ø—Ç–∞ –∫—É–ø–ª–µ–Ω–∞ –∑–∞ –∑–≤—ë–∑–¥—ã!');
              renderInvestments();
            }
          });
        }
      } catch (error) {
        console.error('Error buying stars crypto:', error);
      }
    } else {
      try {
        const result = await apiCall(`/crypto/${cryptoId}/buy`, {
          method: 'POST',
          body: JSON.stringify({ amount })
        });
        if (result.success) {
          state.balance -= result.total_cost;
          state.ownedCryptos.push({ cryptoId, amount, type: 'dino' });
          state.newPurchases += amount;
          updateWalletBadge();
          toast('–ö—Ä–∏–ø—Ç–∞ –∫—É–ø–ª–µ–Ω–∞!');
          renderInvestments();
          saveUserData();
        } else {
          toast(result.error, 'error');
        }
      } catch (error) {
        console.error('Error buying crypto:', error);
      }
    }
  }

  async function sellCrypto(cryptoId, amount = 1) {
    const owned = state.ownedCryptos.find(c => c.cryptoId === cryptoId);
    if (owned.type === 'stars') return toast('–ö—Ä–∏–ø—Ç—É –∑–∞ –∑–≤—ë–∑–¥—ã –Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–∞–≤–∞—Ç—å', 'error');
    try {
      const result = await apiCall(`/crypto/${cryptoId}/sell`, {
        method: 'POST',
        body: JSON.stringify({ amount })
      });
      if (result.success) {
        state.balance += result.total_return;
        owned.amount -= amount;
        if (owned.amount <= 0) state.ownedCryptos = state.ownedCryptos.filter(c => c.cryptoId !== cryptoId);
        toast('–ö—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞–Ω–∞!');
        renderInvestments();
        saveUserData();
      } else {
        toast(result.error, 'error');
      }
    } catch (error) {
      console.error('Error selling crypto:', error);
    }
  }

  async function checkSubscription() {
    try {
      const result = await apiCall('/check-sub');
      if (result.success && result.subscribed) {
        state.balance += 1000000;
        toast('–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É: 1M DINO!');
        saveUserData();
      } else {
        toast('–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫–∞–Ω–∞–ª', 'error');
      }
    } catch (error) {
      console.error('Error checking sub:', error);
    }
  }

  async function loadAdminPayouts() {
    try {
      const result = await apiCall('/admin/payouts');
      if (result.success) {
        state.adminPayouts = result.payouts;
        renderProfile();
      }
    } catch (error) {
      console.error('Error loading admin payouts:', error);
    }
  }

  async function sendPayout(payoutId) {
    try {
      const result = await apiCall(`/admin/payout/${payoutId}`, { method: 'POST' });
      if (result.success) {
        toast('–í—ã–ø–ª–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        loadAdminPayouts();
      }
    } catch (error) {
      console.error('Error sending payout:', error);
    }
  }

  async function deleteItem(type, id) {
    try {
      const result = await apiCall(`/${type}/${id}/delete`, { method: 'DELETE' });
      if (result.success) {
        toast('–£–¥–∞–ª–µ–Ω–æ!');
        loadOwned();
        renderBusiness();
      }
    } catch (error) {
      console.error('Error deleting:', error);
    }
  }

  /*********************
   * Utils
   *********************/
  const uid = (p="id") => p + "_" + Math.random().toString(36).slice(2,9);
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const fmt = (n, d=2) => {
    if (n >= 1e9) return (n/1e9).toFixed(d) + "B";
    if (n >= 1e6) return (n/1e6).toFixed(d) + "M";
    if (n >= 1e3) return (n/1e3).toFixed(d) + "K";
    return Number(n).toFixed(d);
  };
  const now = () => Date.now();

  function save() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    localStorage.setItem(THEME_KEY, state.theme);
  }

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        if (parsed.version < VERSION) {
          Object.assign(state, parsed);
          state.version = VERSION;
        } else {
          Object.assign(state, parsed);
        }
      } catch(_) {}
    }

    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme) {
      state.theme = savedTheme;
      document.body.classList.remove("dark", "light");
      document.body.classList.add(savedTheme);
    }
  }

  function toast(text, type="ok") {
    const el = document.createElement("div");
    el.className = `fade-in rounded-xl px-4 py-3 shadow-dino flex items-start ${type==="error"?"bg-red-500/20 border border-red-400/40":"bg-darkCard border border-darkBorder"}`;
    el.innerHTML = `
      <i class="fa-solid ${type==="error"?"fa-triangle-exclamation text-red-400":"fa-circle-check text-darkPrimary"} mr-2 mt-0.5"></i>
      <div>${text}</div>
    `;
    $toast().appendChild(el);
    setTimeout(() => {
      el.style.opacity = 0;
      setTimeout(()=> el.remove(), 250);
    }, 2200);
  }

  function openModal(innerHTML, onClose = () => {}) {
    $modal().innerHTML = `
      <div class="fixed inset-0 bg-black/70 flex items-end sm:items-center sm:justify-center z-[999] p-4">
        <div class="bg-darkCard w-full max-w-md rounded-2xl p-5 border border-darkBorder shadow-card max-h-[90vh] overflow-y-auto relative">
          <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-darkBgLight flex items-center justify-center hover:bg-darkCardHover">
            <i class="fa-solid fa-xmark"></i>
          </button>
          ${innerHTML}
        </div>
      </div>
    `;
    $modal().firstChild.addEventListener("click", (e)=>{
      if (e.target === e.currentTarget) closeModal();
    });
  }

  function closeModal(){ $modal().innerHTML = ""; }

  function updateWalletBadge() {
    if (state.newPurchases > 0) {
      $walletBadge().textContent = state.newPurchases;
      $walletBadge().classList.remove('hidden');
    } else {
      $walletBadge().classList.add('hidden');
    }
  }

  /*********************
   * Theme Toggle
   *********************/
  function toggleTheme() {
    state.theme = state.theme === "dark" ? "light" : "dark";
    document.body.classList.remove("dark", "light");
    document.body.classList.add(state.theme);
    save();
    renderIfTab("profile", renderProfile);
  }

  /*********************
   * Game Loop
   *********************/
  function tick() {
    const dt = Math.max(0, Math.min(1, (now() - state.lastTick)/1000));
    state.lastTick = now();
    state.dps = 0;
    // Calculate DPS from owned
    state.ownedCryptos.forEach(oc => {
      if (oc.type === 'stars') state.dps += oc.amount * 0.1;
    });
    state.companies.forEach(c => {
      state.dps += c.clients_count * 1;
    });
    state.balance += state.dps * dt;
    updateHeader();

    if (state.xp >= state.xpNext) {
      state.level++;
      state.xp -= state.xpNext;
      state.xpNext = Math.round(state.xpNext * 1.5);
      toast(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã ${state.level} —É—Ä–æ–≤–Ω—è`);
      updateLevel();
      save();
    }

    requestAnimationFrame(tick);
  }

  function updateHeader() {
    $balance().textContent = fmt(state.balance);
    $stars().textContent = fmt(state.stars);
    $ton().textContent = fmt(state.ton);
    $dps().textContent = fmt(state.dps);
    $mobileUsername().textContent = state.user.username;
    $mobileAvatar().src = state.user.avatar_url;
  }

  function updateLevel() {
    $level().textContent = state.level;
    $xpText().textContent = `${Math.floor(state.xp)}/${state.xpNext}`;
  }

  /*********************
   * Navigation
   *********************/
  function setTab(tab) {
    state.currentTab = tab;
    if (tab === 'investments') state.newPurchases = 0; // Reset on open
    updateWalletBadge();

    document.querySelectorAll(".nav-btn").forEach(b => {
      b.classList.remove("active", "bg-darkCardHover");
    });
    const mobileBtn = document.querySelector(`.nav-btn[data-tab='${tab}']`);
    if (mobileBtn) {
      mobileBtn.classList.add("active", "bg-darkCardHover");
    }

    if (tab === "clicker") renderClicker();
    if (tab === "dinonet") renderDinoNet();
    if (tab === "business") renderBusiness();
    if (tab === "investments") renderInvestments();
    if (tab === "profile") renderProfile();
    save();
  }

  function renderIfTab(tab, fn){ if (state.currentTab === tab) fn(); }

  /*********************
   * Clicker
   *********************/
  function renderClicker() {
    $content().innerHTML = `
      <section class="space-y-6">
        <div class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="text-sm text-darkMuted">–î–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫</div>
              <div class="text-xl font-bold text-darkPrimary">${fmt(state.perClick)} DINO</div>
            </div>
            <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="buyClick()">
              <i class="fa-solid fa-arrow-up mr-2"></i>+${ECON.CLICK_INC} –∑–∞ ${fmt(state.clickUpgradeCost)}
            </button>
          </div>
          <div class="text-xs text-darkMuted">–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: ${state.clicks}</div>
          ${state.isGuest ? '<div class="text-xs text-yellow-400 mt-2"><i class="fa-solid fa-exclamation-triangle mr-1"></i>–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º - –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>' : ''}
        </div>

        <div id="click-area" class="card p-8 text-center active:scale-[.995] transition cursor-pointer relative overflow-hidden">
          <div class="text-8xl mb-2 select-none leading-none animate-float">ü¶ñ</div>
          <div class="text-lg font-medium mb-1">–ö–ª–∏–∫–∞–π –ø–æ –¥–∏–Ω–æ–∑–∞–≤—Ä—É</div>
          <div class="text-sm text-darkMuted">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π DINO –∏ —É–ª—É—á—à–∞–π —Å–≤–æ—é —ç–∫–æ–Ω–æ–º–∏–∫—É</div>
        </div>
      </section>
    `;

    document.getElementById("click-area").addEventListener("click", (e) => {
      const inc = state.perClick;
      state.balance += inc;
      state.clicks++;
      state.xp += 0.1;
      updateHeader();
      updateLevel();

      const coin = document.createElement("div");
      coin.className = "coin-pop absolute text-darkSecondary font-medium z-10";
      coin.style.left = (e.offsetX - 10) + "px";
      coin.style.top = (e.offsetY - 10) + "px";
      coin.textContent = `+${inc.toFixed(2)}`;
      e.currentTarget.appendChild(coin);
      setTimeout(() => coin.remove(), 600);

      save();
    });
  }

  function buyClick() {
    if (state.balance < state.clickUpgradeCost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO", "error");
    state.balance -= state.clickUpgradeCost;
    state.perClick += ECON.CLICK_INC;
    state.clickUpgradeCost = Math.ceil(state.clickUpgradeCost * ECON.CLICK_COST_MULT);
    state.xp += 10;
    updateHeader();
    updateLevel();
    renderClicker();
    save();
    toast("–£–ª—É—á—à–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ!");
  }

  /*********************
   * DinoNet
   *********************/
  let dinonetTab = "feed";

  function renderDinoNet() {
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-3 gap-2">
            <button class="tab-btn ${dinonetTab==='feed'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('feed')">
              <i class="fa-solid fa-rss mr-2"></i>–õ–µ–Ω—Ç–∞
            </button>
            <button class="tab-btn ${dinonetTab==='myposts'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('myposts')">
              <i class="fa-solid fa-file-lines mr-2"></i>–ú–æ–∏
            </button>
            <button class="tab-btn ${dinonetTab==='leaders'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('leaders')">
              <i class="fa-solid fa-trophy mr-2"></i>–õ–∏–¥–µ—Ä—ã
            </button>
          </div>
        </div>

        ${dinonetTab==='feed' ? feedPanelHTML() : dinonetTab==='myposts' ? myPostsPanelHTML() : leadersPanelHTML()}
      </section>
    `;
  }

  function setDinoNetTab(t){
    dinonetTab=t;
    if (t === 'leaders') loadLeaderboard();
    renderDinoNet();
  }

  function feedPanelHTML() {
    return `
      <div class="space-y-5">
        <div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>
      </div>
    `;
  }

  function myPostsPanelHTML() {
    return `
      <div class="space-y-4">
        <div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ù–µ—Ç –≤–∞—à–∏—Ö –ø–æ—Å—Ç–æ–≤</p></div>
      </div>
    `;
  }

  function leadersPanelHTML() {
    if (state.leaderboard.length === 0) {
      return `
        <div class="space-y-4">
          <div class="text-center py-10">
            <i class="fa-solid fa-trophy text-4xl text-darkMuted mb-3"></i>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–¥–µ—Ä–æ–≤...</p>
          </div>
        </div>
      `;
    }

    return `
      <div class="space-y-4">
        <div class="flex gap-2 mb-4">
          <button class="px-3 py-1 rounded-lg bg-darkPrimary text-white text-sm" onclick="loadLeaderboard('balance')">
            üí∞ –ü–æ –±–∞–ª–∞–Ω—Å—É
          </button>
          <button class="px-3 py-1 rounded-lg bg-darkCard text-darkMuted text-sm" onclick="loadLeaderboard('level')">
            üéØ –ü–æ —É—Ä–æ–≤–Ω—é
          </button>
          <button class="px-3 py-1 rounded-lg bg-darkCard text-darkMuted text-sm" onclick="loadLeaderboard('clicks')">
            üëÜ –ü–æ –∫–ª–∏–∫–∞–º
          </button>
        </div>
        ${state.leaderboard.map((user, index) => `
          <div class="card p-4 flex items-center">
            <div class="text-2xl font-bold mr-4 ${index < 3 ? 'text-darkSecondary' : 'text-darkMuted'}">#${index + 1}</div>
            <img src="${user.avatar_url}" class="w-10 h-10 rounded-full mr-3">
            <div class="flex-grow">
              <div class="font-bold">${user.name}</div>
              <div class="text-sm text-darkMuted">@${user.username}</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-darkPrimary">${fmt(user.balance)} DINO</div>
              <div class="text-xs text-darkMuted">–£—Ä. ${user.level} ‚Ä¢ ${fmt(user.clicks)} –∫–ª–∏–∫–æ–≤</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  /*********************
   * Business
   *********************/
  let businessTab = "companies";

  function renderBusiness() {
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-3 gap-2">
            <button class="tab-btn ${businessTab==='companies'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('companies')">
              <i class="fa-solid fa-building mr-2"></i>–ë–∏–∑–Ω–µ—Å
            </button>
            <button class="tab-btn ${businessTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('crypto')">
              <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
            </button>
            <button class="tab-btn ${businessTab==='referrals'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('referrals')">
              <i class="fa-solid fa-link mr-2"></i>–†–µ—Ñ–µ—Ä–∞–ª—ã
            </button>
          </div>
        </div>

        ${businessTab==='companies' ? companiesPanelHTML() : businessTab==='crypto' ? cryptoPanelHTML() : referralsPanelHTML()}
      </section>
    `;
  }

  function setBusinessTab(t){ businessTab=t; renderBusiness(); }

  function companiesPanelHTML() {
    return `
      <div class="space-y-5">
        <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium" onclick="openCreateCompanyModal()">
          –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –∑–∞ ${fmt(ECON.COMPANY_CREATE_COST)} DINO
        </button>
        ${state.companies.map(c => `
          <div class="card p-4 cursor-pointer" onclick="openCompanyDetails(${c.id})">
            <div class="font-bold">${c.name}</div>
            <div class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: ${c.clients_count}</div>
            <div class="text-sm text-darkMuted">–ê–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ: ${c.shares_available}</div>
            <div class="text-sm text-darkPrimary">–†–µ—Ñ-—Å—Å—ã–ª–∫–∞: t.me/dinogamebot?start=${c.ref_code}</div>
            ${state.user.username === '@dopoldodo' ? `<button class="mt-2 px-2 py-1 rounded bg-darkDanger text-white" onclick="deleteItem('company', ${c.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function openCreateCompanyModal() {
    openModal(`
      <div class="space-y-4">
        <h2 class="text-xl font-bold mb-2">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h2>
        <p class="text-sm text-yellow-400">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–±–ª—é–¥–∞–π—Ç–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—É –Ω–∞—Å–∏–ª–∏—è –∏–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–µ–º—ã. –ú—ã –∑–∞ –¥–æ–±—Ä—É—é –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É!</p>
        <input id="comp_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ)" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
        <label><input type="checkbox" id="comp_channel" onclick="toggleChannelFields()"> –û—Ç –ª–∏—Ü–∞ Telegram-–∫–∞–Ω–∞–ª–∞</label>
        <div id="channel_fields" class="hidden space-y-2">
          <input id="comp_channel_link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª (@channel)" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
          <input id="comp_channel_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
        </div>
        <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium mt-2" onclick="createCompanyFromModal()">
          –°–æ–∑–¥–∞—Ç—å
        </button>
      </div>
    `);
  }

  function toggleChannelFields() {
    const checked = document.getElementById('comp_channel').checked;
    document.getElementById('channel_fields').classList.toggle('hidden', !checked);
  }

  function createCompanyFromModal() {
    const name = document.getElementById('comp_name').value.trim();
    if (!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
    const channel = document.getElementById('comp_channel').checked;
    const link = channel ? document.getElementById('comp_channel_link').value.trim() : '';
    const channelName = channel ? document.getElementById('comp_channel_name').value.trim() : '';
    createCompany(name, link, channelName);
    closeModal();
  }

  function openCompanyDetails(id) {
    const c = state.companies.find(c => c.id === id);
    if (!c) return;
    openModal(`
      <div class="space-y-4">
        <h2 class="text-xl font-bold">${c.name}</h2>
        <p>–ö–ª–∏–µ–Ω—Ç—ã: ${c.clients_count}</p>
        <p>–ê–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω–æ: ${c.shares_available}</p>
        <p>–¶–µ–Ω–∞ –∞–∫—Ü–∏–∏: ${fmt(10 + c.clients_count * 0.5)}</p>
        <p>–†–µ—Ñ-—Å—Å—ã–ª–∫–∞: t.me/dinogamebot?start=${c.ref_code}</p>
        <button class="w-full py-3 rounded-xl bg-darkPrimary text-white" onclick="buyClient(${id})">–ö—É–ø–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ ${fmt(ECON.CLIENT_COST)} DINO</button>
        <button class="w-full py-3 rounded-xl bg-darkSecondary text-white" onclick="releaseShares(${id})">–í—ã–ø—É—Å—Ç–∏—Ç—å –∞–∫—Ü–∏–∏ –∑–∞ ${fmt(ECON.RELEASE_SHARES_COST)} DINO</button>
      </div>
    `);
  }

  function cryptoPanelHTML() {
    return `
      <div class="space-y-5">
        <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium" onclick="openCreateCryptoModal('dino')">
          –°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç—É –∑–∞ ${fmt(ECON.CRYPTO_CREATE_DINO)} DINO
        </button>
        <button class="w-full py-3 rounded-xl bg-darkSecondary hover:bg-darkSecondary text-white font-medium" onclick="openCreateCryptoModal('stars')">
          –°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç—É –∑–∞ –∑–≤—ë–∑–¥—ã
        </button>
        ${state.cryptos.map(c => `
          <div class="card p-4">
            <div class="font-bold">${c.name}</div>
            <div class="text-sm text-darkMuted">–¢–∏–ø: ${c.created_with === 'dino' ? 'DINO' : '–ó–≤—ë–∑–¥—ã'}</div>
            <div class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: ${c.clients_count}</div>
            <div class="text-sm text-darkMuted">–î–æ—Å—Ç—É–ø–Ω–æ: ${c.created_with === 'stars' ? '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ' : c.supply_available}</div>
            <div class="text-sm text-darkPrimary">–†–µ—Ñ-—Å—Å—ã–ª–∫–∞: t.me/dinogamebot?start=${c.ref_code}</div>
            ${c.created_with === 'dino' ? `<button class="mt-2 px-2 py-1 rounded bg-darkSecondary text-white" onclick="releaseCrypto(${c.id})">–í—ã–ø—É—Å—Ç–∏—Ç—å –∑–∞ ${fmt(ECON.RELEASE_CRYPTO_COST)} DINO</button>` : ''}
            <p class="text-xs text-darkMuted mt-2">–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ: ${c.created_with === 'stars' ? '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 0.1 DPS/–µ–¥–∏–Ω–∏—Ü—É, –≤—ã - 40% –æ—Ç –ø—Ä–æ–¥–∞–∂–∏' : '–¶–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç –æ—Ç –ø—Ä–æ–¥–∞–∂/–∫–ª–∏–µ–Ω—Ç–æ–≤'}</p>
            ${state.user.username === '@dopoldodo' ? `<button class="mt-2 px-2 py-1 rounded bg-darkDanger text-white" onclick="deleteItem('crypto', ${c.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function openCreateCryptoModal(type) {
    openModal(`
      <div class="space-y-4">
        <h2 class="text-xl font-bold mb-2">–°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç—É (${type === 'dino' ? 'DINO' : '–ó–≤—ë–∑–¥—ã'})</h2>
        <p class="text-sm text-yellow-400">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–±–ª—é–¥–∞–π—Ç–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥—É –Ω–∞—Å–∏–ª–∏—è –∏–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–µ–º—ã. –ú—ã –∑–∞ –¥–æ–±—Ä—É—é –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É!</p>
        <input id="crypto_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç—ã (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ)" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
        <label><input type="checkbox" id="crypto_channel" onclick="toggleChannelFields()"> –û—Ç –ª–∏—Ü–∞ Telegram-–∫–∞–Ω–∞–ª–∞</label>
        <div id="channel_fields" class="hidden space-y-2">
          <input id="crypto_channel_link" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª (@channel)" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
          <input id="crypto_channel_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
        </div>
        <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium mt-2" onclick="createCryptoFromModal('${type}')">
          –°–æ–∑–¥–∞—Ç—å
        </button>
      </div>
    `);
  }

  function createCryptoFromModal(type) {
    const name = document.getElementById('crypto_name').value.trim();
    if (!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
    const channel = document.getElementById('crypto_channel').checked;
    const link = channel ? document.getElementById('crypto_channel_link').value.trim() : '';
    const channelName = channel ? document.getElementById('crypto_channel_name').value.trim() : '';
    createCrypto(name, type, link, channelName);
    closeModal();
  }

  async function releaseCrypto(id) {
    if (state.balance < ECON.RELEASE_CRYPTO_COST) return toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO', 'error');
    try {
      const result = await apiCall(`/crypto/${id}/release`, {
        method: 'POST'
      });
      if (result.success) {
        state.balance -= ECON.RELEASE_CRYPTO_COST;
        const crypto = state.cryptos.find(c => c.id === id);
        if (crypto) crypto.supply_available += 100; // Assume 100 per release
        toast('–ö—Ä–∏–ø—Ç–∞ –≤—ã–ø—É—â–µ–Ω–∞!');
        renderBusiness();
        saveUserData();
      }
    } catch (error) {
      console.error('Error releasing crypto:', error);
    }
  }

  function referralsPanelHTML() {
    return `
      <div class="space-y-5">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
          <p class="text-sm text-darkMuted mb-4">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ!</p>
          <p class="text-sm mb-4">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ <a href="https://t.me/dinogamed" class="text-darkPrimary">t.me/dinogamed</a> –∏ –ø–æ–ª—É—á–∏—Ç–µ 1M DINO!</p>
          <button class="w-full py-3 rounded-xl bg-darkPrimary text-white" onclick="checkSubscription()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
          <div class="bg-darkBgLight rounded-xl p-3 mt-4">
            <div class="text-darkMuted text-sm mb-1">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
            <div class="font-semibold text-lg">0</div>
          </div>
        </div>
      </div>
    `;
  }

  /*********************
   * Investments
   *********************/
  let invTab = "stocks";
  state.marketStocks = []; // Load from API
  state.marketCryptos = []; // Load from API

  async function loadMarket() {
    try {
      const stocksResult = await apiCall('/market/stocks');
      if (stocksResult.success) state.marketStocks = stocksResult.stocks;
      const cryptosResult = await apiCall('/market/cryptos');
      if (cryptosResult.success) state.marketCryptos = cryptosResult.cryptos;
    } catch (error) {
      console.error('Error loading market:', error);
    }
  }

  function renderInvestments() {
    loadMarket(); // Refresh
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-3 gap-2">
            <button class="tab-btn ${invTab==='stocks'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('stocks')">
              <i class="fa-solid fa-chart-line mr-2"></i>–ê–∫—Ü–∏–∏
            </button>
            <button class="tab-btn ${invTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('crypto')">
              <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
            </button>
            <button class="tab-btn ${invTab==='wallet'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('wallet')">
              <i class="fa-solid fa-wallet mr-2"></i>–ö–æ—à–µ–ª—ë–∫
            </button>
          </div>
        </div>

        ${invTab==='stocks' ? stocksMarketHTML() : invTab==='crypto' ? cryptoMarketHTML() : walletHTML()}
      </section>
    `;
  }

  function setInvTab(t){ invTab=t; renderInvestments(); }

  function stocksMarketHTML() {
    return `
      <div class="space-y-4">
        ${state.marketStocks.map(s => `
          <div class="card p-4">
            <div class="font-bold">${s.name}</div>
            <div class="text-sm text-darkMuted">–í–ª–∞–¥–µ–ª–µ—Ü: ${s.owner_name || s.tg_channel_name}</div>
            <div class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: ${s.clients_count}</div>
            <div class="text-sm text-darkPrimary">–¶–µ–Ω–∞ –∞–∫—Ü–∏–∏: ${fmt(10 + s.clients_count * 0.5)} DINO</div>
            <div class="text-sm text-darkMuted">–î–æ—Å—Ç—É–ø–Ω–æ: ${s.shares_available}</div>
            <button class="mt-2 px-4 py-2 rounded-xl bg-darkPrimary text-white" onclick="buyShare(${s.id})">–ö—É–ø–∏—Ç—å 1</button>
            ${state.user.username === '@dopoldodo' ? `<button class="mt-2 px-2 py-1 rounded bg-darkDanger text-white" onclick="deleteItem('company', ${s.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function cryptoMarketHTML() {
    return `
      <div class="space-y-4">
        ${state.marketCryptos.map(c => `
          <div class="card p-4">
            <div class="font-bold">${c.name}</div>
            <div class="text-sm text-darkMuted">–í–ª–∞–¥–µ–ª–µ—Ü: ${c.owner_name || c.tg_channel_name}</div>
            <div class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: ${c.clients_count}</div>
            <div class="text-sm text-darkPrimary">–¶–µ–Ω–∞: ${c.created_with === 'stars' ? '10 ‚≠ê' : fmt(1 + c.sales * 0.1 + c.clients_count * 0.2) + ' DINO'}</div>
            <div class="text-sm text-darkMuted">–î–æ—Å—Ç—É–ø–Ω–æ: ${c.created_with === 'stars' ? '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ' : c.supply_available}</div>
            <button class="mt-2 px-4 py-2 rounded-xl bg-darkPrimary text-white" onclick="buyCrypto(${c.id})">–ö—É–ø–∏—Ç—å 1</button>
            ${state.user.username === '@dopoldodo' ? `<button class="mt-2 px-2 py-1 rounded bg-darkDanger text-white" onclick="deleteItem('crypto', ${c.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  function walletHTML() {
    return `
      <div class="space-y-5">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-4">–ê–∫—Ü–∏–∏</h3>
          ${state.ownedShares.length === 0 ? '–ù–µ—Ç –∞–∫—Ü–∏–π' : state.ownedShares.map(s => `
            <div class="flex justify-between items-center mb-2">
              <span>–ö–æ–º–ø–∞–Ω–∏—è ID ${s.companyId}: ${s.amount} —à—Ç.</span>
              <button class="px-2 py-1 rounded bg-darkDanger text-white" onclick="sellShare(${s.companyId})">–ü—Ä–æ–¥–∞—Ç—å 1</button>
            </div>
          `).join('')}
        </div>

        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-4">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</h3>
          ${state.ownedCryptos.length === 0 ? '–ù–µ—Ç –∫—Ä–∏–ø—Ç—ã' : state.ownedCryptos.map(c => `
            <div class="flex justify-between items-center mb-2">
              <span>–ö—Ä–∏–ø—Ç–∞ ID ${c.cryptoId}: ${c.amount} —à—Ç. (${c.type})</span>
              ${c.type === 'dino' ? `<button class="px-2 py-1 rounded bg-darkDanger text-white" onclick="sellCrypto(${c.cryptoId})">–ü—Ä–æ–¥–∞—Ç—å 1</button>` : '<span class="text-darkPrimary">–ü—Ä–∏–Ω–æ—Å–∏—Ç DPS</span>'}
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  /*********************
   * Profile
   *********************/
  function renderProfile() {
    const connectionStatus = state.isGuest ?
      '<div class="bg-yellow-500/20 border border-yellow-400/40 rounded-xl p-3 mb-4"><i class="fa-solid fa-exclamation-triangle text-yellow-400 mr-2"></i>–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º - –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</div>' :
      '<div class="bg-green-500/20 border border-green-400/40 rounded-xl p-3 mb-4"><i class="fa-solid fa-check-circle text-green-400 mr-2"></i>–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É</div>';

    let adminPanel = '';
    if (state.user.username === '@dopoldodo') {
      adminPanel = `
        <div class="card p-5 mt-4">
          <h3 class="font-semibold mb-4">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
          <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥: ${fmt(state.adminTotalIncome)} ‚≠ê</p>
          <p>–ë–∞–ª–∞–Ω—Å: ${fmt(state.adminBalance)} ‚≠ê</p>
          <h4 class="mt-4">–í—ã–ø–ª–∞—Ç—ã:</h4>
          ${state.adminPayouts.map(p => `
            <div class="flex justify-between mb-2">
              <span>–ö—Ä–∏–ø—Ç–∞ ${p.crypto_id}: ${fmt(p.amount)} ‚≠ê</span>
              <button class="px-2 py-1 rounded bg-darkPrimary text-white" onclick="sendPayout(${p.id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          `).join('')}
        </div>
      `;
    }

    $content().innerHTML = `
      <section class="space-y-6">
        ${connectionStatus}

        <div class="card p-5">
          <div class="flex items-center gap-4 mb-4">
            <img src="${state.user.avatar_url}" class="w-16 h-16 rounded-full border-2 border-darkPrimary">
            <div>
              <h2 class="font-bold text-xl">${state.user.first_name} ${state.user.last_name || ''}</h2>
              <p class="text-sm text-darkMuted">@${state.user.username}</p>
            </div>
          </div>
          <p class="text-sm mb-4">${state.user.bio}</p>
          ${state.user.telegram_channel ? `<p class="text-sm text-darkPrimary">Telegram: ${state.user.telegram_channel}</p>` : ''}
          <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium" onclick="openEditProfile()">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
          </button>
        </div>

        <div class="card p-5">
          <h3 class="font-semibold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-darkPrimary">${fmt(state.balance)}</div>
              <div class="text-sm text-darkMuted">DINO</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-darkSecondary">${state.level}</div>
              <div class="text-sm text-darkMuted">–£—Ä–æ–≤–µ–Ω—å</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-darkPrimary">${fmt(state.clicks)}</div>
              <div class="text-sm text-darkMuted">–ö–ª–∏–∫–æ–≤</div>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-darkSecondary">${fmt(state.stars)}</div>
              <div class="text-sm text-darkMuted">–ó–≤—ë–∑–¥—ã</div>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <h3 class="font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span>–¢–µ–º–∞</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder flex items-center" onclick="toggleTheme()">
                <i class="fa-solid fa-${state.theme === 'dark' ? 'moon' : 'sun'} mr-2"></i>${state.theme === 'dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å username –≤ –î–∏–Ω–æ–ù–µ—Ç</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowUsername()">
                ${state.user.show_username ? '–î–∞' : '–ù–µ—Ç'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>XP</span>
              <span class="font-bold">${fmt(state.xp)} / ${state.xpNext}</span>
            </div>
          </div>
        </div>

        ${adminPanel}
      </section>
    `;
  }

  function toggleShowUsername() {
    state.user.show_username = !state.user.show_username;
    save();
    saveUserProfile();
    renderProfile();
  }

  function openEditProfile(){
    openModal(`
      <div class="space-y-4">
        <h2 class="text-xl font-bold mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">–ò–º—è</label>
            <input id="edit_first_name" value="${state.user.first_name}" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">–§–∞–º–∏–ª–∏—è</label>
            <input id="edit_last_name" value="${state.user.last_name || ''}" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">–ë–∏–æ</label>
            <textarea id="edit_bio" rows="3" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3">${state.user.bio}</textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Telegram –∫–∞–Ω–∞–ª</label>
            <input id="edit_tg" value="${state.user.telegram_channel}" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="@channel">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">–ê–≤–∞—Ç–∞—Ä</label>
            <input id="edit_avatar" type="file" accept="image/*" class="hidden">
            <button onclick="document.getElementById('edit_avatar').click()" class="px-4 py-2 rounded-xl bg-darkPrimary text-white">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
            <div id="edit_avatar_preview" class="mt-2"><img src="${state.user.avatar_url}" class="w-16 h-16 rounded-full"></div>
          </div>
        </div>
        <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium mt-2" onclick="saveProfile()">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    `);

    document.getElementById('edit_avatar').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          document.getElementById('edit_avatar_preview').innerHTML = `<img src="${ev.target.result}" class="w-16 h-16 rounded-full">`;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  function saveProfile(){
    const photoFile = document.getElementById("edit_avatar").files[0];
    if (photoFile) {
      const reader = new FileReader();
      reader.onload = (e) => {
        state.user.avatar_url = e.target.result;
        finalizeSaveProfile();
      };
      reader.readAsDataURL(photoFile);
      return;
    }
    finalizeSaveProfile();
  }

  function finalizeSaveProfile() {
    state.user.first_name = document.getElementById("edit_first_name").value.trim();
    state.user.last_name = document.getElementById("edit_last_name").value.trim();
    state.user.bio = document.getElementById("edit_bio").value.trim();
    state.user.telegram_channel = document.getElementById("edit_tg").value.trim();

    closeModal();
    renderProfile();
    updateHeader();
    save();
    saveUserProfile();
  }

  /*********************
   * Init
   *********************/
  async function init() {
    if ($content()) {
      $content().innerHTML = '<div class="text-center py-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-darkPrimary mb-4"></i><p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä—É...</p></div>';
    }

    load();
    document.body.classList.add(state.theme);

    await initUser();

    document.querySelectorAll("[data-tab]").forEach(b =>
      b.addEventListener("click", (e) => setTab(e.currentTarget.dataset.tab))
    );

    setTab(state.currentTab);
    updateHeader();
    updateLevel();
    updateWalletBadge();
    tick();

    setInterval(() => {
      if (!state.isGuest && state.user.id) {
        saveUserData();
      }
    }, 5000);

    toast('ü¶ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DINO Game!');
  }

  init();
  </script>
</body>
</html>
