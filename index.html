<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DINO Game v4 ‚Äî –ë–∏–∑–Ω–µ—Å, –ö—Ä–∏–ø—Ç–∞, –î–∏–Ω–æ–ù–µ—Ç</title>

  <!-- Icons & Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            darkBg: "#0f1117",
            darkBgLight: "#1a1d26",
            darkCard: "#1d212c",
            darkCardHover: "#232734",
            darkPrimary: "#10b981",
            darkPrimaryHover: "#059669",
            darkSecondary: "#facc15",
            darkDanger: "#ef4444",
            darkMuted: "#94a3b8",
            darkBorder: "#2d323d",
            lightBg: "#f0f4f8",
            lightBgLight: "#ffffff",
            lightCard: "#ffffff",
            lightCardHover: "#e5e7eb",
            lightPrimary: "#047857",
            lightPrimaryHover: "#03543f",
            lightSecondary: "#d97706",
            lightDanger: "#b91c1c",
            lightMuted: "#4b5563",
            lightBorder: "#d1d5db"
          },
          boxShadow: {
            dino: "0 10px 30px rgba(16,185,129,.15)",
            card: "0 8px 25px rgba(0,0,0,.3)",
            glow: "0 0 15px rgba(16,185,129,.3)"
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
            'bounce-subtle': 'bounce 1s infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      user-select: none;
    }

    body.dark {
      background-color: #0f1117;
      color: #f8fafc;
    }

    body.light {
      background-color: #f0f4f8;
      color: #1f2937;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #0f1117 0%, #1a1d26 100%);
    }

    .dino-gradient-text {
      background: linear-gradient(90deg, #10b981, #facc15);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-btn.active {
      color: #facc15;
      position: relative;
    }

    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: #facc15;
      border-radius: 3px;
    }

    .tab-btn.active {
      background: #10b981;
      color: #fff;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .dark .card {
      background: #1d212c;
      border: 1px solid #2d323d;
    }

    .light .card {
      background: #ffffff;
      border: 1px solid #d1d5db;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .dark .card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,.2);
      border-color: rgba(16,185,129,.2);
    }

    .light .card:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      border-color: rgba(16,185,129,.2);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .dark .pill {
      background: rgba(16,185,129,.15);
      color: #10b981;
    }

    .light .pill {
      background: rgba(16,185,129,.1);
      color: #047857;
    }

    .fade-in {
      animation: fadein 0.25s ease-out;
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .coin-pop {
      animation: coinPop 0.6s ease-out forwards;
    }

    .progress-bar {
      overflow: hidden;
      border-radius: 10px;
    }

    .dark .progress-bar {
      background: rgba(255, 255, 255, 0.1);
    }

    .light .progress-bar {
      background: rgba(0, 0, 0, 0.05);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes coinPop {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      50% { opacity: 0.8; transform: translateY(-30px) scale(1.1); }
      100% { opacity: 0; transform: translateY(-60px) scale(1); }
    }

    /* Mobile specific styles */
    .mobile-tab-content {
      padding-bottom: 80px;
    }

    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .dark .mobile-bottom-nav {
      background: rgba(29, 33, 44, 0.9);
      border-top: 1px solid #2d323d;
    }

    .light .mobile-bottom-nav {
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid #d1d5db;
    }

    textarea {
      max-height: 100px;
      overflow-y: auto;
      word-break: break-word;
    }

    .post-text {
      overflow: hidden;
      max-height: 100px;
      text-overflow: ellipsis;
    }

    .post-expanded .post-text {
      max-height: none;
    }

    /* Modal styles */
    #modal-root .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 999;
    }

    #modal-root .modal-content {
      background: #1d212c;
      border: 1px solid #2d323d;
      border-radius: 20px;
      padding: 20px;
      width: 500px;        /* –±–∞–∑–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ */
      max-width: 90vw;     /* –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
      max-height: 85vh;    /* –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;           /* —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ */
    }

    /* —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
    #modal-root .modal-content .card,
    #modal-root .modal-content .stat-block {
      max-width: 100%;       /* —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–∏—Å—å —à–∏—Ä–µ –º–æ–¥–∞–ª–∫–∏ */
      font-size: 0.9rem;     /* —Ç–µ–∫—Å—Ç —á—É—Ç—å –º–µ–Ω—å—à–µ */
      padding: 12px 16px;    /* —Å–¥–µ–ª–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
      border-radius: 12px;
    }

  </style>
</head>

<body class="gradient-bg min-h-screen dark"> <!-- Default dark theme -->
  <!-- Mobile Layout (only, desktop removed) -->
  <div>
    <!-- Header -->
    <header class="glass p-4 sticky top-0 z-40 border-b border-darkBorder">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img id="mobile-avatar" src="https://i.pravatar.cc/150?img=10" class="w-10 h-10 rounded-full mr-3">
          <div>
            <div class="font-bold"><span id="mobile-username">DinoUser</span></div>
            <div class="text-xs text-darkMuted"><span id="mobile-balance">0</span> DINO</div>
            <div class="text-xs text-darkMuted"><span id="mobile-dps">0</span>/—Å–µ–∫</div>
          </div>
        </div>
        <div class="flex items-center">
          <div class="mr-3 text-right">
            <div class="text-xs text-darkMuted">–£—Ä. <span id="mobile-level">1</span></div>
            <div class="text-xs text-darkPrimary" id="mobile-xp-text">0/150</div>
          </div>
          <div class="w-8 h-8 rounded-full bg-darkCard flex items-center justify-center">
            <i class="fa-regular fa-user text-sm"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main id="mobile-content" class="mobile-tab-content p-4"></main>

    <!-- Bottom Navigation -->
    <nav class="mobile-bottom-nav p-2 grid grid-cols-5 gap-1">
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="clicker">
        <i class="fa-regular fa-hand-pointer text-lg mb-1"></i>
        <span class="text-xs">–ö–ª–∏–∫–µ—Ä</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="dinonet">
        <i class="fa-solid fa-globe text-lg mb-1"></i>
        <span class="text-xs">–î–∏–Ω–æ–ù–µ—Ç</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="business">
        <i class="fa-solid fa-building text-lg mb-1"></i>
        <span class="text-xs">–ë–∏–∑–Ω–µ—Å</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="investments">
        <i class="fa-solid fa-chart-line text-lg mb-1"></i>
        <span class="text-xs">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="profile">
        <i class="fa-regular fa-user text-lg mb-1"></i>
        <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
      </button>
    </nav>
  </div>

  <!-- Modals / notifications -->
  <div id="modal-root"></div>
  <div id="toast-root" class="fixed top-3 right-3 space-y-2 z-[999] max-w-xs"></div>

  <script>
  /*********************
   * Core Game State & API
   *********************/
  const VERSION = 11; // Updated version
  const LS_KEY = "dinogame_v11_state";
  const THEME_KEY = "dinogame_v11_theme";
  const MODAL_DISABLE_KEY = "dinogame_v11_modal_disabled";

  // API Configuration
  const API_BASE = 'https://dinod.ru/api';
  const TG_CHANNEL = 'https://t.me/dinogamed';

  // Tunable economy constants
  const ECON = {
    CLICK_INC: 1.5,
    CLICK_COST_MULT: 1.6,
    COMPANY_COSTS: [0, 50000, 200000], // First free, second 50k, third 200k
    COMPANY_COOLDOWN: 8 * 60 * 60 * 1000, // 8 hours in ms
    EMISSION_COST_PER_SHARE: 25,
    SHARES_PER_CLIENT: 50,
    BASE_SHARE_PRICE: 1,
    LOW_SHARES_THRESHOLD: 100,
    CLIENT_COST: 10000, // DINO per client
    POST_COST: 25000, // DINO per post
    POST_MAX_LENGTH: 280,
    CRYPTO_COST: 250000,
    CRYPTO_MAX_PER_USER: 1,
    REF_REWARD: 100000,
    CRYPTO_DPS_BASE: 0.01 // –ë–∞–∑–æ–≤—ã–π –µ–∂–µ—Å–µ–∫—É–Ω–¥–Ω—ã–π –¥–æ—Ö–æ–¥
  };

  const state = {
    version: VERSION,
    currentTab: "clicker",
    balance: 1000,
    dps: 0,
    perClick: 2,
    clickUpgradeCost: 200,
    user: {
      id: null,
      telegram_id: null,
      username: "DinoUser",
      first_name: "Dino",
      last_name: "Player",
      avatar_url: "https://i.pravatar.cc/150?img=10",
      bio: "–õ—é–±–∏—Ç–µ–ª—å –¥–∏–Ω–æ–∑–∞–≤—Ä–æ–≤ –∏ –∫–ª–∏–∫–µ—Ä–æ–≤.",
      telegram_channel: "",
      show_owner_on_market: true,
      show_username_crypto: true,
      show_username_dinonet: true,
      is_moderator: false,
      banned: false
    },
    clicks: 0,
    level: 1,
    xp: 0,
    xpNext: 150,
    theme: "dark",
    lastTick: Date.now(),
    isGuest: false,
    saveInProgress: false,
    startParam: Telegram.WebApp.initDataUnsafe.start_param || null,
    lastCompanyCreateTime: null,
    likedPosts: new Set(),
    referrals: 0,
    cryptoOwned: null
  };

  // Elements
  const $content = () => document.getElementById("mobile-content");
  const $balance = () => document.getElementById("mobile-balance");
  const $dps = () => document.getElementById("mobile-dps");
  const $level = () => document.getElementById("mobile-level");
  const $xpText = () => document.getElementById("mobile-xp-text");
  const $modal = () => document.getElementById("modal-root");
  const $toast = () => document.getElementById("toast-root");
  const $mobileUsername = () => document.getElementById("mobile-username");
  const $mobileAvatar = () => document.getElementById("mobile-avatar");

  /*********************
   * API Functions
   *********************/
  async function apiCall(endpoint, options = {}) {
    try {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API call failed:', error);
      toast('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
      throw error;
    }
  }

  async function initUser() {
    try {
      let userData = {};

      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe.user) {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        userData = {
          telegram_id: tgUser.id,
          username: tgUser.username || 'DinoUser',
          first_name: tgUser.first_name || 'Dino',
          last_name: tgUser.last_name || '',
          avatar_url: tgUser.photo_url || "https://i.pravatar.cc/150?img=10",
          is_guest: false
        };
        state.isGuest = false;
      } else {
        userData = { is_guest: true };
        state.isGuest = true;
      }

      const result = await apiCall('/user', {
        method: 'POST',
        body: JSON.stringify(userData)
      });

      if (result.success) {
        updateStateFromUser(result.user);
        await fetchNotifications();
        if (state.user.banned) {
          toast('–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã', 'error');
        }
        toast('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
        if (state.startParam && state.startParam.startsWith('ref-')) {
          const referrerId = state.startParam.split('ref-')[1];
          await apiCall('/referrals/register', {
            method: 'POST',
            body: JSON.stringify({ referred_id: state.user.id, referrer_id })
          });
          setTab('profile');
        }
        return result.user;
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      console.error('Failed to initialize user:', error);
      state.isGuest = true;
      toast('–†–∞–±–æ—Ç–∞–µ–º –≤ –≥–æ—Å—Ç–µ–≤–æ–º —Ä–µ–∂–∏–º–µ', 'error');
      return null;
    }
  }

  async function fetchNotifications() {
    try {
      const result = await apiCall(`/notifications?user_id=${state.user.id}`);
      if (result.success) {
        result.notifications.forEach(n => toast(n.message, 'error'));
        await apiCall('/notifications/clear', {
          method: 'POST',
          body: JSON.stringify({ user_id: state.user.id })
        });
      }
    } catch (err) {}
  }

  function updateStateFromUser(user) {
    if (!user) return;

    state.user = { ...state.user, ...user };
    state.balance = user.balance || state.balance;
    state.perClick = user.per_click || state.perClick;
    state.clickUpgradeCost = user.click_upgrade_cost || state.clickUpgradeCost;
    state.clicks = user.clicks || state.clicks;
    state.level = user.level || state.level;
    state.xp = user.xp || state.xp;
    state.xpNext = user.xp_next || state.xpNext;
    state.user.show_owner_on_market = user.show_owner_on_market !== false; 
    state.user.show_username_crypto = user.show_username_crypto !== false; 
    state.user.show_username_dinonet = user.show_username_dinonet !== false; 
    state.user.is_moderator = user.is_moderator || false;
    state.user.banned = user.banned || false;
  }

  async function saveUserData() {
    if (state.isGuest || state.saveInProgress || !state.user.id || state.user.banned) return;

    state.saveInProgress = true;

    try {
      const result = await apiCall(`/user/${state.user.id}`, {
        method: 'PUT',
        body: JSON.stringify({
          balance: state.balance,
          per_click: state.perClick,
          click_upgrade_cost: state.clickUpgradeCost,
          clicks: state.clicks,
          level: state.level,
          xp: state.xp,
          xp_next: state.xpNext,
          show_owner_on_market: state.user.show_owner_on_market,
          show_username_crypto: state.user.show_username_crypto,
          show_username_dinonet: state.user.show_username_dinonet
        })
      });

      if (!result.success) {
        console.error('Failed to save user data:', result.error);
      }
    } catch (error) {
      console.error('Error saving user data:', error);
    } finally {
      state.saveInProgress = false;
    }
  }

  /*********************
   * Utils
   *********************/
  const uid = (p="id") => p + "_" + Math.random().toString(36).slice(2,9);
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const fmt = (n, d=0) => {
    n = Number(n).toFixed(d);
    if (Number(n) >= 1e9) return (Number(n)/1e9).toFixed(d) + "B";
    if (Number(n) >= 1e6) return (Number(n)/1e6).toFixed(d) + "M";
    if (Number(n) >= 1e3) return (Number(n)/1e3).toFixed(d) + "K";
    return n;
  };
  const now = () => Date.now();

  function save() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    localStorage.setItem(THEME_KEY, state.theme);
  }

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed.version < VERSION) {
        Object.assign(state, parsed);
        state.version = VERSION;
      } else {
        Object.assign(state, parsed);
      }
    } catch(_) {}

    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme) {
      state.theme = savedTheme;
      document.body.classList.remove("dark", "light");
      document.body.classList.add(savedTheme);
    }
  }

  function toast(text, type="ok") {
    const el = document.createElement("div");
    el.className = `fade-in rounded-xl px-4 py-3 shadow-dino flex items-start \${type==="error"?"bg-red-500/20 border border-red-400/40":"bg-darkCard border border-darkBorder"}\`;
    el.innerHTML = `
      <i class="fa-solid \${type==="error"?"fa-triangle-exclamation text-red-400":"fa-circle-check text-darkPrimary"}\ mr-2 mt-0.5"></i>
      <div>\${text}</div>
    `;
    $toast().appendChild(el);
    setTimeout(() => {
      el.style.opacity = 0;
      setTimeout(()=> el.remove(), 250);
    }, 2200);
  }

  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function openModal(innerHTML, onClose = () => {}) {
    $modal().innerHTML = `
      <div class="modal">
        <div class="modal-content">
          <div class="flex justify-end mb-2">
            <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          \${innerHTML}
        </div>
      </div>
    `;
    $modal().firstChild.addEventListener("click", (e)=>{
      if (e.target === e.currentTarget) closeModal();
    });
  }

  function closeModal(){ $modal().innerHTML = ""; }

  function formatTime(ms) {
    const hours = Math.floor(ms / (3600 * 1000));
    const minutes = Math.floor((ms % (3600 * 1000)) / (60 * 1000));
    const seconds = Math.floor((ms % (60 * 1000)) / 1000);
    return `\${hours}h \${minutes}m \${seconds}s`;
  }

  /*********************
   * Theme Toggle
   *********************/
  function toggleTheme() {
    state.theme = state.theme === "dark" ? "light" : "dark";
    document.body.classList.remove("dark", "light");
    document.body.classList.add(state.theme);
    save();
    renderIfTab("profile", renderProfile);
  }

  /*********************
   * Game Loop
   *********************/
  function tick() {
    const dt = Math.max(0, Math.min(1, (now() - state.lastTick)/1000));
    state.lastTick = now();
    state.balance += state.dps * dt;
    updateHeader();

    if (state.xp >= state.xpNext) {
      state.level++;
      state.xp -= state.xpNext;
      state.xpNext = Math.round(state.xpNext * 1.5);
      toast(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã \${state.level} —É—Ä–æ–≤–Ω—è`);
      updateLevel();
      save();
    }

    requestAnimationFrame(tick);
  }

  function updateHeader() {
    $balance().textContent = fmt(state.balance);
    $dps().textContent = fmt(state.dps);
    $mobileUsername().textContent = state.user.username;
    $mobileAvatar().src = state.user.avatar_url;
  }

  function updateLevel() {
    $level().textContent = state.level;
    $xpText().textContent = `\${Math.floor(state.xp)}/\${state.xpNext}`;
  }

  /*********************
   * Navigation
   *********************/
  function setTab(tab) {
    state.currentTab = tab;

    document.querySelectorAll(".nav-btn").forEach(b => {
      b.classList.remove("active", "bg-darkCardHover");
    });
    const mobileBtn = document.querySelector(`.nav-btn[data-tab='\${tab}']`);
    if (mobileBtn) {
      mobileBtn.classList.add("active", "bg-darkCardHover");
    }

    if (tab === "clicker") renderClicker();
    if (tab === "dinonet") renderDinoNet();
    if (tab === "business") renderBusiness();
    if (tab === "investments") renderInvestments();
    if (tab === "profile") renderProfile();
    save();
  }

  function renderIfTab(tab, fn){ if (state.currentTab === tab) fn(); }

  /*********************
   * Clicker
   *********************/
  function renderClicker() {
    $content().innerHTML = `
      <section class="space-y-6">
        <div class="card p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="text-sm text-darkMuted">–î–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫</div>
              <div class="text-xl font-bold text-darkPrimary">\${fmt(state.perClick)} DINO</div>
            </div>
            <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="buyClick()">
              <i class="fa-solid fa-arrow-up mr-2"></i>+\${ECON.CLICK_INC} –∑–∞ \${fmt(state.clickUpgradeCost)}
            </button>
          </div>
          <div class="text-xs text-darkMuted">–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: \${state.clicks}</div>
          \${state.isGuest ? '<div class="text-xs text-yellow-400 mt-2"><i class="fa-solid fa-exclamation-triangle mr-1"></i>–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º - –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>' : ''}
        </div>

        <div id="click-area" class="card p-8 text-center active:scale-[.995] transition cursor-pointer relative overflow-hidden">
          <div class="text-8xl mb-2 select-none leading-none animate-float">ü¶ñ</div>
          <div class="text-lg font-medium mb-1">–ö–ª–∏–∫–∞–π –ø–æ –¥–∏–Ω–æ–∑–∞–≤—Ä—É</div>
          <div class="text-sm text-darkMuted">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π DINO –∏ —É–ª—É—á—à–∞–π —Å–≤–æ—é —ç–∫–æ–Ω–æ–º–∏–∫—É</div>
        </div>
      </section>
    `;

    document.getElementById("click-area").addEventListener("click", (e) => {
      const inc = state.perClick;
      state.balance += inc;
      state.clicks++;
      state.xp += 0.1;
      updateHeader();
      updateLevel();

      const coin = document.createElement("div");
      coin.className = "coin-pop absolute text-darkSecondary font-medium z-10";
      coin.style.left = (e.offsetX - 10) + "px";
      coin.style.top = (e.offsetY - 10) + "px";
      coin.textContent = `+\${inc.toFixed(2)}`;
      e.currentTarget.appendChild(coin);
      setTimeout(() => coin.remove(), 600);

      save();
    });
  }

  function buyClick() {
    if (state.balance < state.clickUpgradeCost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO", "error");
    state.balance -= state.clickUpgradeCost;
    state.perClick += ECON.CLICK_INC;
    state.clickUpgradeCost = Math.ceil(state.clickUpgradeCost * ECON.CLICK_COST_MULT);
    state.xp += 10;
    updateHeader();
    updateLevel();
    renderClicker();
    save();
    toast("–£–ª—É—á—à–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ!");
  }

  /*********************
   * DinoNet
   *********************/
  let dinonetTab = "feed";
  let dinonetRefreshInterval = null;

  async function renderDinoNet() {
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-2 gap-2">
            <button class="tab-btn \${dinonetTab==='feed'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('feed')">
              <i class="fa-solid fa-rss mr-2"></i>–õ–µ–Ω—Ç–∞
            </button>
            <button class="tab-btn \${dinonetTab==='myposts'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('myposts')">
              <i class="fa-solid fa-file-lines mr-2"></i>–ú–æ–∏
            </button>
          </div>
        </div>

        \${dinonetTab==='feed' ? await feedPanelHTML() : await myPostsPanelHTML()}
      </section>
    `;

    if (dinonetRefreshInterval) clearInterval(dinonetRefreshInterval);
    dinonetRefreshInterval = setInterval(() => {
      if (state.currentTab === 'dinonet') {
        renderDinoNet();
      }
    }, 60000); // Refresh every minute
  }

  function setDinoNetTab(t){
    dinonetTab=t;
    renderDinoNet();
  }

  async function feedPanelHTML() {
    if (state.isGuest || state.user.banned) {
      return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';
    }

    try {
      const result = await apiCall(`/posts?mode=feed&limit=20`);
      if (!result.success) {
        return '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>';
      }
      const posts = result.posts;

      let html = `
        <div class="space-y-5">
          <button class="w-full px-4 py-5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium text-lg" onclick="createPostModal()">
            –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
          </button>
      `;
      posts.forEach(p => {
        const ownerText = p.company_count > 0 ? `–í–ª–∞–¥–µ–ª–µ—Ü: \${p.company_count} –∫–æ–º–ø–∞–Ω–∏–π` : '';
        const username = state.user.show_username_dinonet ? `@\${p.username}` : '–ê–Ω–æ–Ω–∏–º';
        const isLiked = state.likedPosts.has(p.id);
        const likeIcon = isLiked ? 'fa-solid' : 'fa-regular';
        const likeColor = isLiked ? 'text-red-400' : '';
        html += `
          <div class="card p-4">
            <div class="flex items-center mb-2">
              <img src="\${p.avatar_url}" class="w-8 h-8 rounded-full mr-2">
              <div>
                <div class="font-bold">\${username}</div>
                <div class="text-xs text-darkMuted">\${ownerText}</div>
              </div>
            </div>
            <p class="post-text mb-2">\${p.text}</p>
            <div class="flex text-sm text-darkMuted">
              <span class="mr-4"><i class="fa-regular fa-eye mr-1"></i>\${fmt(p.views)}</span>
              <span class="flex items-center"><button onclick="likePost('\${p.id}')"><i class="\${likeIcon} fa-heart mr-1 \${likeColor}"></i></button>\${fmt(p.likes + (isLiked ? 1 : 0))}</span>
            </div>
            \${state.user.is_moderator ? `<button class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-sm text-white flex items-center mt-2" onclick="deletePostMod('\${p.id}')"><i class="fa-solid fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function likePost(id) {
    if (state.likedPosts.has(id)) {
      state.likedPosts.delete(id);
      await apiCall('/posts/like', {
        method: 'DELETE',
        body: JSON.stringify({ post_id: id, user_id: state.user.id })
      });
    } else {
      state.likedPosts.add(id);
      await apiCall('/posts/like', {
        method: 'POST',
        body: JSON.stringify({ post_id: id, user_id: state.user.id })
      });
    }
    renderDinoNet();
  }

  function createPostModal() {
    const cost = state.user.is_moderator ? 0 : ECON.POST_COST;
    openModal(`
      <h2 class="font-bold text-xl mb-4">–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h2>
      <p class="text-sm text-yellow-400 mb-4">–ù–µ –ø–∏—à–∏—Ç–µ –Ω–∏—á–µ–≥–æ –ø–ª–æ—Ö–æ–≥–æ –∏ —Ç.–¥. –ú—ã –∑–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.</p>
      <textarea id="post-text" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="–í–∞—à —Ç–µ–∫—Å—Ç (max \${ECON.POST_MAX_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="\${ECON.POST_MAX_LENGTH}"></textarea>
      <div class="text-sm text-yellow-400 mb-4">–°—Ç–æ–∏–º–æ—Å—Ç—å: \${fmt(cost)} DINO</div>
      <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="doCreatePost()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    `);
  }

  async function doCreatePost() {
    const text = document.getElementById('post-text').value.trim();
    if (!text || text.length > ECON.POST_MAX_LENGTH) return toast('–ù–µ–≤–µ—Ä–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞', 'error');

    try {
      const result = await apiCall('/posts', {
        method: 'POST',
        body: JSON.stringify({ user_id: state.user.id, text })
      });
      if (result.success) {
        closeModal();
        toast('–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω!');
        state.balance = result.updated_balance;
        updateHeader();
        renderDinoNet();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function myPostsPanelHTML() {
    if (state.isGuest || state.user.banned) {
      return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';
    }

    try {
      const result = await apiCall(`/posts?mode=my&user_id=\${state.user.id}&limit=50`);
      if (!result.success) {
        return '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ù–µ—Ç –≤–∞—à–∏—Ö –ø–æ—Å—Ç–æ–≤</p></div>';
      }
      const posts = result.posts;

      let html = '<div class="space-y-4">';
      posts.forEach(p => {
        html += `
          <div class="card p-4">
            <p class="post-text mb-2">\${p.text}</p>
            <div class="flex text-sm text-darkMuted mb-2">
              <span class="mr-4"><i class="fa-regular fa-eye mr-1"></i>\${fmt(p.views)}</span>
              <span><i class="fa-regular fa-heart mr-1"></i>\${fmt(p.likes)}</span>
            </div>
            <button class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-sm text-white flex items-center" onclick="deletePost('\${p.id}')">
              <i class="fa-solid fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function deletePost(id) {
    try {
      const result = await apiCall(`/posts/\${id}`, {
        method: 'DELETE',
        body: JSON.stringify({ user_id: state.user.id })
      });
      if (result.success) {
        toast('–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω!');
        renderDinoNet();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function deletePostMod(id) {
    try {
      const result = await apiCall(`/posts/\${id}/delete_mod`, {
        method: 'POST',
        body: JSON.stringify({ mod_user_id: state.user.id })
      });
      if (result.success) {
        toast('–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º!');
        renderDinoNet();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  /*********************
   * Business
   *********************/
  let businessTab = "company";

  async function renderBusiness() {
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-3 gap-2">
            <button class="tab-btn \${businessTab==='company'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('company')">
              <i class="fa-solid fa-building mr-2"></i>–ö–æ–º–ø–∞–Ω–∏—è
            </button>
            <button class="tab-btn \${businessTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('crypto')">
              <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
            </button>
            <button class="tab-btn \${businessTab==='referrals'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('referrals')">
              <i class="fa-solid fa-link mr-2"></i>–†–µ—Ñ–µ—Ä–∞–ª—ã
            </button>
          </div>
        </div>

        \${businessTab==='company' ? await companyPanelHTML() : businessTab==='crypto' ? await cryptoPanelHTML() : await referralsPanelHTML()}
      </section>
    `;
  }

  function setBusinessTab(t){ businessTab=t; renderBusiness(); }

  async function companyPanelHTML(){
    if (state.isGuest || state.user.banned) {
      return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';
    }

    try {
      const result = await apiCall('/companies?owner_id=' + state.user.id);
      if (!result.success) {
        return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π</p></div>';
      }
      const companies = result.companies;

      let html = '<div class="space-y-4">';
      if (companies.length < 3) {
        html += `<button id="create-company-btn" class="w-full px-4 py-5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium text-lg" onclick="handleCreateCompanyClick()">
          –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
        </button>`;
      }
      companies.forEach(c => {
        html += `
          <button class="w-full text-left px-4 py-5 rounded-xl bg-darkCard hover:bg-darkCardHover border border-darkBorder" onclick="viewCompanyDetails('\${c.id}')">
            <div class="flex justify-between items-center">
              <span class="font-bold">\${c.name}</span>
              <span class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: \${fmt(c.clients_count)} | –¶–µ–Ω–∞ –∞–∫—Ü–∏–∏: \${fmt(c.share_price, 2)}</span>
            </div>
          </button>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function handleCreateCompanyClick() {
    const result = await apiCall('/companies?owner_id=' + state.user.id);
    const companies = result.companies;
    const count = companies.length;

    const lastCreated = companies.length > 0 ? new Date(Math.max(...companies.map(c => new Date(c.created_at)))) : null;
    const cooldownEnd = lastCreated ? new Date(lastCreated.getTime() + ECON.COMPANY_COOLDOWN) : new Date(0);
    if (now() < cooldownEnd) {
      const timeLeft = cooldownEnd - now();
      openModal(`
        <div class="text-center">
          <h2 class="font-bold text-xl mb-4">–¢–∞–π–º–µ—Ä</h2>
          <p class="mb-4">–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–ø–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.</p>
          <p class="text-2xl font-bold text-red-400">\${formatTime(timeLeft)}</p>
        </div>
      `);
      return;
    }

    const cost = ECON.COMPANY_COSTS[count];
    if (state.balance < cost) {
      toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏', 'error');
      return;
    }

    openModal(`
      <h2 class="font-bold text-xl mb-4">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h2>
      <p class="text-sm text-gray-400 mb-4">–ú—ã —Ü–µ–Ω–∏–º —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–æ—Ö–∏—Ö —Å–ª–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.</p>
      <input id="company-name" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
      <div class="text-sm text-yellow-400 mb-4">–°—Ç–æ–∏–º–æ—Å—Ç—å: \${fmt(cost)} DINO</div>
      <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="doCreateCompany()">–°–æ–∑–¥–∞—Ç—å</button>
    `);
  }

  async function doCreateCompany() {
    const name = document.getElementById('company-name').value.trim();
    if (!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');

    try {
      const result = await apiCall('/companies', {
        method: 'POST',
        body: JSON.stringify({ name, owner_id: state.user.id })
      });
      if (result.success) {
        closeModal();
        toast('–ö–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
        const ref = `https://t.me/dinosav_bot?start=ref-\${result.company.id}`;
        openModal(`
          <h2 class="font-bold text-xl mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h2>
          <p class="text-sm text-gray-400 mb-4">\${ref}</p>
          <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="copyText('\${ref}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        `);
        state.balance = result.updated_balance;
        updateHeader();
        renderBusiness();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function viewCompanyDetails(id) {
    if (state.user.banned) return toast('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
    try {
      const result = await apiCall(`/companies/\${id}`);
      if (!result.success) return toast('–û—à–∏–±–∫–∞', 'error');
      const c = result.company;
      const isOwner = c.owner_id === state.user.id;
      const ref = `https://t.me/dinosav_bot?start=ref-\${c.id}`;
      const maxEmit = c.max_emitable;
      const avail = c.available_shares;
      const price = c.share_price;

      let html = `
        <div class="space-y-4">
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <h2 class="font-bold text-xl mb-1">\${c.name}</h2>

          <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="card p-3 text-center">
              <div class="text-gray-400 text-sm mb-1">–ö–ª–∏–µ–Ω—Ç—ã</div>
              <div class="bg-darkBgLight rounded px-2 py-1 font-semibold text-lg">\${fmt(c.clients_count)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–¶–µ–Ω–∞ –∞–∫—Ü–∏–∏</div>
              <div class="font-semibold text-lg text-green-400">\${fmt(price, 2)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –∞–∫—Ü–∏–π</div>
              <div class="font-semibold text-lg">\${fmt(avail)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–î–æ—Ö–æ–¥ –æ—Ç –ø—Ä–æ–¥–∞–∂</div>
              <div class="font-semibold text-lg">\${fmt(c.revenue || 0)}</div>
            </div>
          </div>

          <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ -->
          <div class="card flex items-center justify-between p-3 mb-4">
            <div class="text-sm truncate">
              <span class="text-gray-400">–†–µ—Ñ. —Å—Å—ã–ª–∫–∞: </span><span>\${ref}</span>
            </div>
            <button class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-sm text-white flex items-center"
              onclick="copyText('\${ref}')">
              <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
      `;

      if (isOwner) {
        html += `
          <!-- –≠–º–∏—Å—Å–∏—è –∞–∫—Ü–∏–π -->
          <div class="card p-4">
            <div class="font-semibold mb-2 flex items-center text-yellow-400">
              <i class="fa-solid fa-print mr-2"></i>–≠–º–∏—Å—Å–∏—è –∞–∫—Ü–∏–π
            </div>
            <div class="text-xs text-gray-400 mb-2">–î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–ø—É—Å–∫—É: \${fmt(maxEmit)}</div>
            <div class="flex items-center gap-2">
              <input id="emi_\${c.id}" type="number" min="1" max="\${maxEmit}"
                class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2"
                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
              <button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white"
                onclick="emitShares('\${c.id}', \${maxEmit})">
                –í—ã–ø—É—Å—Ç–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-yellow-400 mt-1">–°—Ç–æ–∏–º–æ—Å—Ç—å: \${ECON.EMISSION_COST_PER_SHARE} DINO/–∞–∫—Ü–∏—è</div>
          </div>

          <!-- –ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
          <div class="card p-4">
            <div class="font-semibold mb-2 flex items-center text-emerald-500">
              <i class="fa-solid fa-users mr-2"></i>–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤
            </div>
            <div class="text-xs text-gray-400 mb-2">–ü–æ–∫—É–ø–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã –∞–∫—Ü–∏–π</div>
            <div class="flex items-center gap-2">
              <input id="clients-amt-\${c.id}" type="number" min="1"
                class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2"
                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
              <button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white"
                onclick="buyClientsDino('\${c.id}')">
                –ö—É–ø–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-yellow-400 mt-1">–°—Ç–æ–∏–º–æ—Å—Ç—å: \${ECON.CLIENT_COST} DINO/–∫–ª–∏–µ–Ω—Ç</div>
          </div>

          <!-- –£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é -->
          <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mt-4"
            onclick="confirmDeleteCompany('\${c.id}')">
            –£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
          </button>
        `;
      } else {
        html += `
          <!-- –ö—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏ -->
          <div class="card p-4">
            <div class="font-semibold mb-2 flex items-center text-green-400">
              <i class="fa-solid fa-shopping-cart mr-2"></i>–ö—É–ø–∏—Ç—å –∞–∫—Ü–∏–∏
            </div>
            <div class="flex items-center gap-2">
              <input id="buy-amt-\${c.id}" type="number" min="1" max="\${avail}"
                class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2"
                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
              <button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white"
                onclick="buyShares('\${c.id}')">
                –ö—É–ø–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-yellow-400 mt-1">–í–∞—à–∏ –∞–∫—Ü–∏–∏: \${fmt(c.your_shares || 0)}</div>
          </div>
        `;
      }

      html += '</div>';
      openModal(html);

      if (isOwner && avail < ECON.LOW_SHARES_THRESHOLD) {
        setTimeout(() => {
          openModal(`
            <div class="text-center">
              <h2 class="font-bold text-xl mb-4">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
              <p class="mb-4">–í–∞—à–∏ –∞–∫—Ü–∏–∏ –Ω–∞ —Ä—ã–Ω–∫–µ –∫–æ–Ω—á–∞—é—Ç—Å—è. –í—ã–ø—É—Å—Ç–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ.</p>
              <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ë–∏–∑–Ω–µ—Å" - –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é –∫–æ–º–ø–∞–Ω–∏—é –∏ –≤—ã–ø—É—Å—Ç–∏—Ç–µ –∞–∫—Ü–∏–∏.</p>
            </div>
          `);
        }, 500);
      }
    } catch (err) {}
  }

  async function buyClientsDino(id) {
    const amtInput = document.getElementById(`clients-amt-\${id}`);
    const amount = parseInt(amtInput.value);
    if (isNaN(amount) || amount <= 0) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');

    try {
      const result = await apiCall(`/companies/\${id}/buy_clients`, {
        method: 'POST',
        body: JSON.stringify({ amount, user_id: state.user.id })
      });
      if (result.success) {
        toast('–ö–ª–∏–µ–Ω—Ç—ã –∫—É–ø–ª–µ–Ω—ã!');
        state.balance = result.updated_balance;
        updateHeader();
        closeModal();
        viewCompanyDetails(id);
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  function copyText(text) {
    navigator.clipboard.writeText(text);
    toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: " + text);
  }

  async function emitShares(id, maxEmit) {
    const amount = parseInt(document.getElementById(`emi_\${id}`).value);
    if (isNaN(amount) || amount <= 0 || amount > maxEmit) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');
    try {
      const result = await apiCall(`/companies/\${id}/emit`, {
        method: 'POST',
        body: JSON.stringify({ amount })
      });
      if (result.success) {
        toast('–ê–∫—Ü–∏–∏ –≤—ã–ø—É—â–µ–Ω—ã!');
        closeModal();
        viewCompanyDetails(id);
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  function confirmDeleteCompany(id) {
    openModal(`
      <div class="text-center">
        <h2 class="font-bold text-xl mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p class="mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é?</p>
        <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mb-2" onclick="confirmDeleteCompanyFinal('\${id}')">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        <button class="w-full py-3 rounded-xl bg-gray-600 text-white" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `);
  }

  async function confirmDeleteCompanyFinal(id) {
    try {
      const result = await apiCall(`/companies/\${id}`, { method: 'DELETE' });
      if (result.success) {
        toast("–ö–æ–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞!");
        closeModal();
        renderBusiness();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function deleteCompanyMod(id) {
    openModal(`
      <div class="text-center">
        <h2 class="font-bold text-xl mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
        <p class="mb-4">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –∫–∞–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä?</p>
        <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mb-2" onclick="deleteCompanyModFinal('\${id}')">–î–∞</button>
        <button class="w-full py-3 rounded-xl bg-gray-600 text-white" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `);
  }

  async function deleteCompanyModFinal(id) {
    try {
      const result = await apiCall(`/companies/\${id}/delete_mod`, {
        method: 'POST',
        body: JSON.stringify({ mod_user_id: state.user.id })
      });
      if (result.success) {
        toast("–ö–æ–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º!");
        closeModal();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function cryptoPanelHTML(){
    if (state.isGuest || state.user.banned) {
      return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';
    }

    try {
      const result = await apiCall('/cryptos?owner_id=' + state.user.id);
      if (!result.success) {
        return '<div class="text-center py-10"><i class="fa-regular fa-coins text-4xl text-darkMuted mb-3"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
      }
      const cryptos = result.cryptos;

      let html = '<div class="space-y-4">';
      if (cryptos.length < ECON.CRYPTO_MAX_PER_USER) {
        html += `<button class="w-full px-4 py-5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium text-lg" onclick="handleCreateCryptoClick()">
          –°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç—É
        </button>`;
      }
      cryptos.forEach(c => {
        html += `
          <button class="w-full text-left px-4 py-5 rounded-xl bg-darkCard hover:bg-darkCardHover border border-darkBorder" onclick="viewCryptoDetails('\${c.id}')">
            <div class="flex justify-between items-center">
              <span class="font-bold">\${c.name} (\${c.ticker})</span>
              <span class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: \${fmt(c.clients_count)} | –¶–µ–Ω–∞: \${fmt(c.price, 2)}</span>
            </div>
          </button>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10"><i class="fa-regular fa-coins text-4xl text-darkMuted mb-3"></i><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function handleCreateCryptoClick() {
    if (state.balance < ECON.CRYPTO_COST) {
      toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–∏–ø—Ç—ã', 'error');
      return;
    }

    openModal(`
      <h2 class="font-bold text-xl mb-4">–°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç—É</p>
      <p class="text-sm text-gray-400 mb-4">–ú—ã —Ü–µ–Ω–∏–º —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–ª–æ—Ö–∏—Ö —Å–ª–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.</p>
      <input id="crypto-name" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç—ã">
      <input id="crypto-ticker" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (BTC)">
      <div class="text-sm text-yellow-400 mb-4">–°—Ç–æ–∏–º–æ—Å—Ç—å: \${fmt(ECON.CRYPTO_COST)} DINO</div>
      <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="doCreateCrypto()">–°–æ–∑–¥–∞—Ç—å</button>
    `);
  }

  async function doCreateCrypto() {
    const name = document.getElementById('crypto-name').value.trim();
    const ticker = document.getElementById('crypto-ticker').value.trim();
    if (!name || !ticker) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–∏–∫–µ—Ä', 'error');

    try {
      const result = await apiCall('/cryptos', {
        method: 'POST',
        body: JSON.stringify({ name, ticker, owner_id: state.user.id })
      });
      if (result.success) {
        closeModal();
        toast('–ö—Ä–∏–ø—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!');
        const ref = `https://t.me/dinosav_bot?start=crypto-ref-\${result.crypto.id}`;
        openModal(`
          <h2 class="font-bold text-xl mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h2>
          <p class="text-sm text-gray-400 mb-4">\${ref}</p>
          <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="copyText('\${ref}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        `);
        state.balance = result.updated_balance;
        updateHeader();
        renderBusiness();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function viewCryptoDetails(id) {
    if (state.user.banned) return toast('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
    try {
      const result = await apiCall(`/cryptos/\${id}`);
      if (!result.success) return toast('–û—à–∏–±–∫–∞', 'error');
      const c = result.crypto;
      const isOwner = c.owner_id === state.user.id;
      const ref = `https://t.me/dinosav_bot?start=crypto-ref-\${c.id}`;
      const avail = c.available;
      const price = c.price;
      const dps = c.dps;

      let html = `
        <div class="space-y-4">
          <h2 class="font-bold text-xl mb-1">\${c.name} (\${c.ticker})</h2>

          <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="card p-3 text-center">
              <div class="text-gray-400 text-sm mb-1">–ö–ª–∏–µ–Ω—Ç—ã</div>
              <div class="bg-darkBgLight rounded px-2 py-1 font-semibold text-lg">\${fmt(c.clients_count)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–¶–µ–Ω–∞</div>
              <div class="font-semibold text-lg text-green-400">\${fmt(price, 2)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–î–æ—Å—Ç—É–ø–Ω–æ</div>
              <div class="font-semibold text-lg">\${fmt(avail)}</div>
            </div>
            <div class="card p-3">
              <div class="text-gray-400 text-sm mb-1">–î–æ—Ö–æ–¥/—Å–µ–∫</div>
              <div class="font-semibold text-lg">\${fmt(dps, 4)}</div>
            </div>
          </div>

          <div class="card flex items-center justify-between p-3 mb-4">
            <div class="text-sm truncate">
              <span class="text-gray-400">–†–µ—Ñ. —Å—Å—ã–ª–∫–∞: </span><span>\${ref}</span>
            </div>
            <button class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-sm text-white flex items-center"
              onclick="copyText('\${ref}')">
              <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
      `;

      if (isOwner) {
        html += `
          <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mt-4"
            onclick="confirmDeleteCrypto('\${c.id}')">
            –£–¥–∞–ª–∏—Ç—å –∫—Ä–∏–ø—Ç—É
          </button>
        `;
      } else {
        html += `
          <div class="card p-4">
            <div class="font-semibold mb-2 flex items-center text-green-400">
              <i class="fa-solid fa-shopping-cart mr-2"></i>–ö—É–ø–∏—Ç—å
            </div>
            <div class="flex items-center gap-2">
              <input id="buy-crypto-amt-\${c.id}" type="number" min="1" max="\${avail}"
                class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2"
                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
              <button class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white"
                onclick="buyCrypto('\${c.id}')">
                –ö—É–ø–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-yellow-400 mt-1">–í–∞—à–∏: \${fmt(c.your_amount || 0)}</div>
          </div>
        `;
      }

      html += '</div>';
      openModal(html);
    } catch (err) {}
  }

  async function buyCrypto(id) {
    const amtInput = document.getElementById(`buy-crypto-amt-\${id}`);
    const amount = parseInt(amtInput.value);
    if (isNaN(amount) || amount <= 0) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');

    try {
      const result = await apiCall('/market/buy_crypto', {
        method: 'POST',
        body: JSON.stringify({ crypto_id: id, amount, user_id: state.user.id })
      });
      if (result.success) {
        toast('–ö—Ä–∏–ø—Ç–∞ –∫—É–ø–ª–µ–Ω–∞!');
        state.balance = result.updated_balance;
        state.dps += result.new_dps;
        updateHeader();
        closeModal();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  function confirmDeleteCrypto(id) {
    openModal(`
      <div class="text-center">
        <h2 class="font-bold text-xl mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p class="mb-4">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—Ä–∏–ø—Ç—É?</p>
        <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mb-2" onclick="confirmDeleteCryptoFinal('\${id}')">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        <button class="w-full py-3 rounded-xl bg-gray-600 text-white" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `);
  }

  async function confirmDeleteCryptoFinal(id) {
    try {
      const result = await apiCall(`/cryptos/\${id}`, { method: 'DELETE' });
      if (result.success) {
        toast("–ö—Ä–∏–ø—Ç–∞ —É–¥–∞–ª–µ–Ω–∞!");
        closeModal();
        renderBusiness();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function referralsPanelHTML() {
    if (state.isGuest || state.user.banned) {
      return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';
    }

    try {
      const result = await apiCall('/referrals?user_id=' + state.user.id);
      if (!result.success) {
        return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
      }
      state.referrals = result.referrals;

      const ref = `https://t.me/dinosav_bot?start=ref-\${state.user.id}`;
      return `
        <div class="space-y-5">
          <div class="card p-5">
            <h3 class="font-semibold text-lg mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
            <p class="text-sm text-darkMuted mb-4">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ \${fmt(ECON.REF_REWARD)} DINO –∑–∞ –∫–∞–∂–¥–æ–≥–æ!</p>
            <div class="bg-darkBgLight rounded-xl p-3 mb-4">
              <div class="text-darkMuted text-sm mb-1">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
              <div class="font-semibold text-lg">\${state.referrals}</div>
            </div>
            <div class="flex items-center gap-2">
              <input value="\${ref}" class="flex-1 px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder" readonly>
              <button class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="copyText('\${ref}')">
                <i class="fa-regular fa-copy"></i>
              </button>
            </div>
          </div>
          <div class="card p-5">
            <h3 class="font-semibold text-lg mb-4">–ù–∞—à Telegram –∫–∞–Ω–∞–ª</h3>
            <p class="text-sm text-darkMuted mb-4">–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏!</p>
            <a href="\${TG_CHANNEL}" class="w-full px-4 py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium text-lg text-center block">
              –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
            </a>
          </div>
        </div>
      `;
    } catch (err) {
      return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  function copyRefLink() {
    const ref = `https://t.me/dinosav_bot?start=ref-\${state.user.id}`;
    copyText(ref);
  }

  /*********************
   * Investments
   *********************/
  let invTab = "stocks";
  let searchQuery = "";

  async function renderInvestments(){
    $content().innerHTML = `
      <section class="space-y-5">
        <div class="card p-2">
          <div class="grid grid-cols-3 gap-2">
            <button class="tab-btn \${invTab==='stocks'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('stocks')">
              <i class="fa-solid fa-chart-line mr-2"></i>–ê–∫—Ü–∏–∏
            </button>
            <button class="tab-btn \${invTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('crypto')">
              <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
            </button>
            <button class="tab-btn \${invTab==='wallet'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('wallet')">
              <i class="fa-solid fa-wallet mr-2"></i>–ö–æ—à–µ–ª—ë–∫
            </button>
          </div>
        </div>

        \${invTab==='stocks' ? await stocksMarketHTML() : invTab==='crypto' ? await cryptoMarketHTML() : await walletHTML()}
      </section>
    `;
  }

  function setInvTab(t){ invTab=t; renderInvestments(); }

  async function stocksMarketHTML(){
    if (state.isGuest || state.user.banned) return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';

    try {
      const result = await apiCall(`/market/companies?user_id=\${state.user.id}`);
      if (!result.success) return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
      let companies = result.companies;

      if (searchQuery) {
        companies = companies.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));
      }

      let html = `
        <div class="space-y-4">
          <input id="stock-search" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏" value="\${searchQuery}" oninput="debouncedUpdateSearch()">
      `;
      companies.forEach(c => {
        const isOwn = c.owner_id === state.user.id;
        const owner = c.show_owner_on_market ? `@\${c.owner_username}` : '';
        const highlight = isOwn ? 'card-own' : '';
        const priceColor = c.share_price > ECON.BASE_SHARE_PRICE ? 'price-up' : 'price-down';
        html += `
          <div class="card \${highlight}" onclick="viewCompanyDetails('\${c.id}')">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="font-bold text-lg">\${c.name}</h3>
                <p class="text-sm text-gray-400">\${owner}</p>
              </div>
              <span class="text-lg font-bold \${priceColor}">\${fmt(c.share_price, 2)}<br>–¶–ï–ù–ê</span>
            </div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                <div class="stat-value">\${fmt(c.clients_count)}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                <div class="stat-value">\${fmt(c.available_shares)}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">–í–∞—à–∏</div>
                <div class="stat-value">\${fmt(c.your_shares || 0)}</div>
              </div>
            </div>
            \${state.user.is_moderator ? `<button class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-sm text-white flex items-center mt-2" onclick="event.stopPropagation(); deleteCompanyMod('\${c.id}')"><i class="fa-solid fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  const debouncedUpdateSearch = debounce(updateSearch, 300);

  function updateSearch() {
    searchQuery = document.getElementById('stock-search').value;
    renderInvestments();
  }

  async function buyShares(companyId) {
    const amtInput = document.getElementById(`buy-amt-\${companyId}`);
    const amount = parseInt(amtInput.value);
    if (isNaN(amount) || amount <= 0) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');

    try {
      const result = await apiCall('/market/buy', {
        method: 'POST',
        body: JSON.stringify({ company_id: companyId, amount, user_id: state.user.id })
      });
      if (result.success) {
        toast('–ê–∫—Ü–∏–∏ –∫—É–ø–ª–µ–Ω—ã!');
        state.balance = result.updated_balance;
        updateHeader();
        closeModal();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function cryptoMarketHTML(){
    if (state.isGuest || state.user.banned) return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';

    try {
      const result = await apiCall(`/market/cryptos?user_id=\${state.user.id}`);
      if (!result.success) return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
      const cryptos = result.cryptos;

      let html = '<div class="space-y-4">';
      cryptos.forEach(c => {
        const isOwn = c.owner_id === state.user.id;
        const owner = state.user.show_username_crypto ? `@\${c.owner_username}` : '';
        const highlight = isOwn ? 'card-own' : '';
        const priceColor = c.price > ECON.BASE_SHARE_PRICE ? 'price-up' : 'price-down';
        html += `
          <div class="card \${highlight}" onclick="viewCryptoDetails('\${c.id}')">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="font-bold text-lg">\${c.name} (\${c.ticker})</h3>
                <p class="text-sm text-gray-400">\${owner}</p>
              </div>
              <span class="text-lg font-bold \${priceColor}">\${fmt(c.price, 2)}<br>–¶–ï–ù–ê</span>
            </div>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                <div class="stat-value">\${fmt(c.clients_count)}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                <div class="stat-value">\${fmt(c.available)}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">–í–∞—à–∏</div>
                <div class="stat-value">\${fmt(c.your_amount || 0)}</div>
              </div>
            </div>
            <div class="stat-item mt-2">
              <div class="stat-label">–î–æ—Ö–æ–¥/—Å–µ–∫</div>
              <div class="stat-value">\${fmt(c.dps, 4)}</div>
            </div>
            \${state.user.is_moderator ? `<button class="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-sm text-white flex items-center mt-2" onclick="event.stopPropagation(); deleteCryptoMod('\${c.id}')"><i class="fa-solid fa-trash mr-1"></i>–£–¥–∞–ª–∏—Ç—å</button>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function deleteCryptoMod(id) {
    openModal(`
      <div class="text-center">
        <h2 class="font-bold text-xl mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
        <p class="mb-4">–£–¥–∞–ª–∏—Ç—å –∫—Ä–∏–ø—Ç—É –∫–∞–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä?</p>
        <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mb-2" onclick="deleteCryptoModFinal('\${id}')">–î–∞</button>
        <button class="w-full py-3 rounded-xl bg-gray-600 text-white" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `);
  }

  async function deleteCryptoModFinal(id) {
    try {
      const result = await apiCall(`/cryptos/\${id}/delete_mod`, {
        method: 'POST',
        body: JSON.stringify({ mod_user_id: state.user.id })
      });
      if (result.success) {
        toast("–ö—Ä–∏–ø—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º!");
        closeModal();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function walletHTML(){
    if (state.isGuest || state.user.banned) return '<div class="text-center py-10 card"><p>–§—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p></div>';

    try {
      const result = await apiCall(`/holdings?user_id=\${state.user.id}`);
      if (!result.success) return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
      const holdings = result.holdings;

      let html = '<div class="space-y-5"><div class="card p-5"><h3 class="font-semibold text-lg mb-4">–ê–∫—Ü–∏–∏</h3>';
      if (holdings.length === 0) {
        html += '–ù–µ—Ç –∞–∫—Ü–∏–π –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ';
      } else {
        holdings.forEach(h => {
          const profit = h.amount * (h.current_price - h.average_purchase_price);
          const profitColor = profit >= 0 ? 'text-green-400' : 'text-red-400';
          html += `
            <div class="card p-4 border border-darkBorder rounded-xl mb-4">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-bold text-lg">\${h.company_name}</h3>
                </div>
                <span class="text-lg font-bold text-green-400">\${fmt(h.current_price, 2)}</span>
              </div>
              <div class="flex justify-between text-sm mb-3">
                <span>–ö–ª–∏–µ–Ω—Ç—ã: \${fmt(h.clients_count)}</span>
                <span>–ê–∫—Ü–∏–π: \${fmt(h.amount)}</span>
                <span class="\${profitColor}">–ü—Ä–∏–±—ã–ª—å: \${fmt(profit, 2)}</span>
              </div>
              <div class="flex mt-2">
                <input id="sell-amt-\${h.id}" type="number" min="1" max="\${h.amount}" class="flex-1 px-4 py-3 rounded-l-xl bg-darkBgLight border border-darkBorder" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                <button class="px-4 py-3 rounded-r-xl bg-darkDanger text-white" onclick="sellShares(\${h.id})">–ü—Ä–æ–¥–∞—Ç—å</button>
              </div>
            </div>
          `;
        });
      }
      html += '</div><div class="card p-5"><h3 class="font-semibold text-lg mb-4">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</h3>';
      const cryptoResult = await apiCall(`/crypto_holdings?user_id=\${state.user.id}`);
      if (!cryptoResult.success) html += '–ù–µ—Ç –∫—Ä–∏–ø—Ç—ã –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ';
      else {
        cryptoResult.holdings.forEach(h => {
          const profit = h.amount * (h.current_price - h.avg_price);
          const profitColor = profit >= 0 ? 'text-green-400' : 'text-red-400';
          html += `
            <div class="card p-4 border border-darkBorder rounded-xl mb-4">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <h3 class="font-bold text-lg">\${h.name} (\${h.ticker})</h3>
                </div>
                <span class="text-lg font-bold text-green-400">\${fmt(h.current_price, 2)}</span>
              </div>
              <div class="flex justify-between text-sm mb-3">
                <span>–ö–ª–∏–µ–Ω—Ç—ã: \${fmt(h.clients_count)}</span>
                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: \${fmt(h.amount)}</span>
                <span class="\${profitColor}">–ü—Ä–∏–±—ã–ª—å: \${fmt(profit, 2)}</span>
              </div>
              <div class="flex mt-2">
                <input id="sell-crypto-amt-\${h.id}" type="number" min="1" max="\${h.amount}" class="flex-1 px-4 py-3 rounded-l-xl bg-darkBgLight border border-darkBorder" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                <button class="px-4 py-3 rounded-r-xl bg-darkDanger text-white" onclick="sellCrypto(\${h.id})">–ü—Ä–æ–¥–∞—Ç—å</button>
              </div>
            </div>
          `;
        });
      }
      html += '</div></div>';
      return html;
    } catch (err) {
      return '<div class="text-center py-10 card"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p></div>';
    }
  }

  async function sellShares(holdingId) {
    const amtInput = document.getElementById(`sell-amt-\${holdingId}`);
    const amount = parseInt(amtInput.value);
    if (isNaN(amount) || amount <= 0) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');

    try {
      const result = await apiCall('/market/sell', {
        method: 'POST',
        body: JSON.stringify({ holding_id: holdingId, amount, user_id: state.user.id })
      });
      if (result.success) {
        toast('–ê–∫—Ü–∏–∏ –ø—Ä–æ–¥–∞–Ω—ã!');
        state.balance = result.updated_balance;
        updateHeader();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function sellCrypto(holdingId) {
    const amtInput = document.getElementById(`sell-crypto-amt-\${holdingId}`);
    const amount = parseInt(amtInput.value);
    if (isNaN(amount) || amount <= 0) return toast('–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error');

    try {
      const result = await apiCall('/market/sell_crypto', {
        method: 'POST',
        body: JSON.stringify({ holding_id: holdingId, amount, user_id: state.user.id })
      });
      if (result.success) {
        toast('–ö—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞–Ω–∞!');
        state.balance = result.updated_balance;
        state.dps -= result.removed_dps;
        updateHeader();
        renderInvestments();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  /*********************
   * Profile
   *********************/
  async function renderProfile() {
    const result = await apiCall('/companies?owner_id=' + state.user.id);
    const companies = result.companies || [];
    let ownedHtml = '';
    if (companies.length === 0) {
      ownedHtml = '<p class="text-center text-darkMuted">–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π</p>';
    } else {
      ownedHtml = '<div class="space-y-3">';
      companies.forEach(c => {
        ownedHtml += `
          <div class="card p-3 rounded-xl bg-darkCardHover flex justify-between items-center">
            <span class="font-medium">\${c.name}</span>
            <span class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: \${fmt(c.clients_count)}</span>
          </div>
        `;
      });
      ownedHtml += '</div>';
    }

    let modHtml = '';
    if (state.user.is_moderator) {
      modHtml = `
        <div class="card p-5 mt-4">
          <h3 class="font-semibold mb-4">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä: –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
          <input id="user-search" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" placeholder="Username">
          <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="searchUsers()">–ü–æ–∏—Å–∫</button>
          <div id="search-results" class="space-y-2 mt-4"></div>
        </div>
      `;
    }

    $content().innerHTML = `
      <section class="space-y-6">
        <div class="card p-5">
          <div class="flex items-center gap-4 mb-4">
            <img src="\${state.user.avatar_url}" class="w-16 h-16 rounded-full border-2 border-darkPrimary">
            <div>
              <h2 class="font-bold text-xl">\${state.user.first_name} \${state.user.last_name || ''}</h2>
              <p class="text-sm text-darkMuted">@\${state.user.username}</p>
            </div>
          </div>
          <p class="text-sm mb-4">\${state.user.bio}</p>
          \${state.user.telegram_channel ? `<p class="text-sm text-darkPrimary">Telegram: \${state.user.telegram_channel}</p>` : ''}
        </div>

        <div class="card p-5">
          <h3 class="font-semibold mb-4">–í–ª–∞–¥–µ–ª–µ—Ü</h3>
          \${ownedHtml}
        </div>

        <div class="card p-5">
          <h3 class="font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <span>–¢–µ–º–∞</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder flex items-center" onclick="toggleTheme()">
                <i class="fa-solid fa-\${state.theme === 'dark' ? 'moon' : 'sun'} mr-2"></i>\${state.theme === 'dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ö–æ–∑—è–∏–Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ —Ä—ã–Ω–∫–µ</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowOwner()">
                \${state.user.show_owner_on_market ? '–î–∞' : '–ù–µ—Ç'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∫—Ä–∏–ø—Ç—ã</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowUsernameCrypto()">
                \${state.user.show_username_crypto ? '–î–∞' : '–ù–µ—Ç'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —é–∑–µ—Ä–Ω–µ–π–º –≤ —Ä–∞–∑–¥–µ–ª–µ –î–∏–Ω–æ–ù–µ—Ç</span>
              <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowUsernameDinonet()">
                \${state.user.show_username_dinonet ? '–î–∞' : '–ù–µ—Ç'}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <span>XP</span>
              <span class="font-bold">\${fmt(state.xp)} / \${state.xpNext}</span>
            </div>
          </div>
        </div>
        \${modHtml}
      </section>
    `;
  }

  function toggleShowOwner() {
    state.user.show_owner_on_market = !state.user.show_owner_on_market;
    save();
    saveUserData();
    renderProfile();
  }

  function toggleShowUsernameCrypto() {
    state.user.show_username_crypto = !state.user.show_username_crypto;
    save();
    saveUserData();
    renderProfile();
  }

  function toggleShowUsernameDinonet() {
    state.user.show_username_dinonet = !state.user.show_username_dinonet;
    save();
    saveUserData();
    renderProfile();
  }

  async function searchUsers() {
    const query = document.getElementById('user-search').value.trim();
    if (!query) return toast('–í–≤–µ–¥–∏—Ç–µ username', 'error');

    try {
      const result = await apiCall(`/user/search?username=\${query}`);
      if (result.success) {
        let html = '';
        result.users.forEach(u => {
          html += `
            <div class="flex justify-between items-center p-2 bg-darkBgLight rounded-xl">
              <span>@\${u.username}</span>
              <button class="px-3 py-1 rounded-lg bg-red-600 text-white" onclick="banUser(\${u.id})">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          `;
        });
        document.getElementById('search-results').innerHTML = html;
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  async function banUser(userId) {
    openModal(`
      <div class="text-center">
        <h2 class="font-bold text-xl mb-4">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
        <p class="mb-4">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</p>
        <button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mb-2" onclick="banUserFinal(\${userId})">–î–∞</button>
        <button class="w-full py-3 rounded-xl bg-gray-600 text-white" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    `);
  }

  async function banUserFinal(userId) {
    try {
      const result = await apiCall(`/user/\${userId}/ban`, {
        method: 'POST',
        body: JSON.stringify({ mod_user_id: state.user.id })
      });
      if (result.success) {
        toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        closeModal();
        renderProfile();
      } else {
        toast(result.error, 'error');
      }
    } catch (err) {}
  }

  /*********************
   * Promo Modal
   *********************/
  function showPromoModal() {
    if (localStorage.getItem(MODAL_DISABLE_KEY)) return;
    const isInvite = Math.random() > 0.5;
    const ref = `https://t.me/dinosav_bot?start=ref-\${state.user.id}`;
    openModal(`
      <h2 class="font-bold text-xl mb-4">–ê–∫—Ü–∏—è!</h2>
      <p class="mb-4">\${isInvite ? '–í–æ—Ç —Ç–≤–æ—è —Å—Å—ã–ª–∫–∞ - –ø—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏ 100 —Ç—ã—Å—è—á DINO!' : '–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª!'}</p>
      \${isInvite ? `<input value="\${ref}" class="w-full px-4 py-3 rounded-xl bg-darkBgLight border border-darkBorder mb-4" readonly>
      <button class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white" onclick="copyText('\${ref}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>` : `<a href="\${TG_CHANNEL}" class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-center block">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>`}
      <button class="w-full py-3 rounded-xl bg-gray-600 text-white mt-2" onclick="disablePromoModal()">–ë–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</button>
    `);
  }

  function disablePromoModal() {
    localStorage.setItem(MODAL_DISABLE_KEY, '1');
    closeModal();
  }

  /*********************
   * Init
   *********************/
  async function init() {
    if ($content()) {
      $content().innerHTML = '<div class="text-center py-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-darkPrimary mb-4"></i><p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä—É...</p></div>';
    }

    load();
    document.body.classList.add(state.theme);

    await initUser();

    document.querySelectorAll("[data-tab]").forEach(b =>
      b.addEventListener("click", (e) => setTab(e.currentTarget.dataset.tab))
    );

    setTab(state.currentTab);
    updateHeader();
    updateLevel();
    tick();

    setInterval(() => {
      if (!state.isGuest && state.user.id && !state.user.banned) {
        saveUserData();
      }
    }, 30000);

    setTimeout(() => {
      setInterval(showPromoModal, 5 * 60 * 1000);
    }, 60 * 1000); // –ü–µ—Ä–≤–æ–µ —á–µ—Ä–µ–∑ 1 –º–∏–Ω, –∑–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 5

    toast('ü¶ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DINO Game!');
  }

  init();
  </script>
</body>
</html>
