<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DINO Game v2 ‚Äî –ë–∏–∑–Ω–µ—Å, –ö—Ä–∏–ø—Ç–∞, –î–∏–Ω–æ–ù–µ—Ç</title>

  <!-- Icons & Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // Dark theme colors
            darkBg: "#0f1117",
            darkBgLight: "#1a1d26",
            darkCard: "#1d212c",
            darkCardHover: "#232734",
            darkPrimary: "#10b981",
            darkPrimaryHover: "#059669",
            darkSecondary: "#facc15",
            darkDanger: "#ef4444",
            darkMuted: "#94a3b8",
            darkBorder: "#2d323d",

            // Light theme colors optimized
            lightBg: "#f0f4f8",
            lightBgLight: "#ffffff",
            lightCard: "#ffffff",
            lightCardHover: "#e5e7eb",
            lightPrimary: "#047857",
            lightPrimaryHover: "#03543f",
            lightSecondary: "#d97706",
            lightDanger: "#b91c1c",
            lightMuted: "#4b5563",
            lightBorder: "#d1d5db"
          },
          boxShadow: {
            dino: "0 10px 30px rgba(16,185,129,0.15)",
            card: "0 8px 25px rgba(0,0,0,0.3)",
            glow: "0 0 15px rgba(16,185,129,0.3)"
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
            'bounce-subtle': 'bounce 1s infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      user-select: none;
    }

    body.dark {
      background-color: #0f1117;
      color: #f8fafc;
    }

    body.light {
      background-color: #f0f4f8;
      color: #1f2937;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #0f1117 0%, #1a1d26 100%);
    }

    .dino-gradient-text {
      background: linear-gradient(90deg, #10b981, #facc15);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-btn.active {
      color: #facc15;
      position: relative;
    }

    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 3px;
      background: #facc15;
      border-radius: 3px;
    }

    .tab-btn.active {
      background: #10b981;
      color: #fff;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .dark .card {
      background: #1d212c;
      border: 1px solid #2d323d;
    }

    .light .card {
      background: #ffffff;
      border: 1px solid #d1d5db;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .dark .card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,.2);
      border-color: rgba(16,185,129,.2);
    }

    .light .card:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      border-color: rgba(16,185,129,.2);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .dark .pill {
      background: rgba(16,185,129,.15);
      color: #10b981;
    }

    .light .pill {
      background: rgba(16,185,129,.1);
      color: #047857;
    }

    .fade-in {
      animation: fadein 0.25s ease-out;
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .coin-pop {
      animation: coinPop 0.6s ease-out forwards;
    }

    .progress-bar {
      overflow: hidden;
      border-radius: 10px;
    }

    .dark .progress-bar {
      background: rgba(255, 255, 255, 0.1);
    }

    .light .progress-bar {
      background: rgba(0, 0, 0, 0.05);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes coinPop {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      50% { opacity: 0.8; transform: translateY(-30px) scale(1.1); }
      100% { opacity: 0; transform: translateY(-60px) scale(1); }
    }

    /* Mobile specific styles */
    .mobile-tab-content {
      padding-bottom: 80px;
    }

    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .dark .mobile-bottom-nav {
      background: rgba(29, 33, 44, 0.9);
      border-top: 1px solid #2d323d;
    }

    .light .mobile-bottom-nav {
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid #d1d5db;
    }

    textarea {
      max-height: 100px;
      overflow-y: auto;
      word-break: break-word;
    }

    .post-text {
      overflow: hidden;
      max-height: 100px;
      text-overflow: ellipsis;
    }

    .post-expanded .post-text {
      max-height: none;
    }
  </style>
</head>

<body class="gradient-bg min-h-screen dark"> <!-- Default dark theme -->
  <!-- Mobile Layout -->
  <div>
    <!-- Header -->
    <header class="glass p-4 sticky top-0 z-40 border-b border-darkBorder">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <img id="mobile-avatar" src="https://i.pravatar.cc/150?img=10" class="w-10 h-10 rounded-full mr-3">
          <div>
            <div class="font-bold"><span id="mobile-username">DinoUser</span></div>
            <div class="text-xs text-darkMuted"><span id="mobile-balance">0</span> DINO</div>
            <div class="text-xs text-darkMuted"><span id="mobile-dps">0</span>/—Å–µ–∫</div>
          </div>
        </div>
        <div class="flex items-center">
          <div class="mr-3 text-right">
            <div class="text-xs text-darkMuted">–£—Ä. <span id="mobile-level">1</span></div>
            <div class="text-xs text-darkPrimary" id="mobile-xp-text">0/150</div>
          </div>
          <div class="w-8 h-8 rounded-full bg-darkCard flex items-center justify-center">
            <i class="fa-regular fa-user text-sm"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main id="mobile-content" class="mobile-tab-content p-4 pb-20"></main>

    <!-- Bottom Navigation -->
    <nav class="mobile-bottom-nav p-2 grid grid-cols-5 gap-1">
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="clicker">
        <i class="fa-regular fa-hand-pointer text-lg mb-1"></i>
        <span class="text-xs">–ö–ª–∏–∫–µ—Ä</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="dinonet">
        <i class="fa-solid fa-globe text-lg mb-1"></i>
        <span class="text-xs">–î–∏–Ω–æ–ù–µ—Ç</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="business">
        <i class="fa-solid fa-building text-lg mb-1"></i>
        <span class="text-xs">–ë–∏–∑–Ω–µ—Å</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="investments">
        <i class="fa-solid fa-chart-line text-lg mb-1"></i>
        <span class="text-xs">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</span>
      </button>
      <button class="nav-btn flex flex-col items-center py-2 rounded-xl transition-all" data-tab="profile">
        <i class="fa-regular fa-user text-lg mb-1"></i>
        <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
      </button>
    </nav>
  </div>

  <!-- Modals / notifications -->
  <div id="modal-root"></div>
  <div id="toast-root" class="fixed top-3 right-3 space-y-2 z-[999] max-w-xs"></div>

  <script>
    /*********************
     * Core Constants
     *********************/
    const API_BASE = 'https://dinod.ru/api';
    const VERSION = 5; // Updated version
    const LS_KEY = "dinogame_v5_local";
    const THEME_KEY = "dinogame_v5_theme";
    const TOKEN_KEY = "dinogame_v5_token";

    // Tunable economy constants
    const ECON = {
      CLICK_INC: 1.5,
      CLICK_COST_MULT: 1.6,
      EMISSION_COST_PER_SHARE: 10,
      CLIENT_COST_DINO: 10000,
      STOCK_BASE_PRICE: 1,
      STOCK_PRICE_PER_CLIENT: 0.05,
      STOCK_PRICE_SMOOTH: 0.2,
      CRYPTO_DINO_COST: 50000,
      CRYPTO_SUPPLY_LIMIT: 1000,
      CRYPTO_PRICE_PER_INVESTOR: 0.01,
      CRYPTO_SMOOTH: 0.1,
      CRYPTO_DPS_RATE_DIVISOR: 10,
      CRYPTO_OWNER_SHARE_DINO: 1.0,
      REF_REWARD: 100000,
      POST_COST_DINO: 50000,
      POST_COST_STARS: 10,
      CLIENT_STARS: {cost: 50, clients: 500},
      CLIENT_TON: {cost: 10, clients: 750}
    };

    // Local state
    const state = {
      version: VERSION,
      currentTab: "clicker",
      theme: "dark",
      clicks: 0,
      timeInGame: 0,
      noInvite: false,
      noSubscribe: false,
      referred: false,
      postDraft: "",
      economy: {
        balance: 1000,
        dps: 0,
        perClick: 2,
        level: 1,
        xp: 0,
        xpNext: 150,
        clickUpgradeCost: 200
      },
      user: null,
      isAdmin: false,
      usersCache: {},
      lastTick: Date.now(),
      lastSync: Date.now()
    };

    // Elements
    const $content = () => document.getElementById("mobile-content");
    const $balance = () => document.getElementById("mobile-balance");
    const $dps = () => document.getElementById("mobile-dps");
    const $level = () => document.getElementById("mobile-level");
    const $xpText = () => document.getElementById("mobile-xp-text");
    const $modal = () => document.getElementById("modal-root");
    const $toast = () => document.getElementById("toast-root");
    const $mobileUsername = () => document.getElementById("mobile-username");
    const $mobileAvatar = () => document.getElementById("mobile-avatar");

    /*********************
     * API Helper
     *********************/
    const api = {
      async get(url) {
        const token = localStorage.getItem(TOKEN_KEY);
        const res = await fetch(API_BASE + url, {
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      },
      async post(url, body) {
        const token = localStorage.getItem(TOKEN_KEY);
        const res = await fetch(API_BASE + url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { Authorization: `Bearer ${token}` } : {})
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
    };

    /*********************
     * Utils
     *********************/
    const uid = (p="id") => p + "_" + Math.random().toString(36).slice(2,9);
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const fmt = (n, d=2) => {
      if (n >= 1e9) return (n/1e9).toFixed(d) + "B";
      if (n >= 1e6) return (n/1e6).toFixed(d) + "M";
      if (n >= 1e3) return (n/1e3).toFixed(d) + "K";
      return Number(n).toFixed(d);
    };
    const now = () => Date.now();

    const copyText = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        toast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
      } catch {
        toast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", "error");
      }
    };

    function saveLocal() {
      localStorage.setItem(LS_KEY, JSON.stringify({
        theme: state.theme,
        clicks: state.clicks,
        timeInGame: state.timeInGame,
        noInvite: state.noInvite,
        noSubscribe: state.noSubscribe,
        referred: state.referred
      }));
      localStorage.setItem(THEME_KEY, state.theme);
    }

    function loadLocal() {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        Object.assign(state, parsed);
      }
      const savedTheme = localStorage.getItem(THEME_KEY);
      if (savedTheme) state.theme = savedTheme;
    }

    function toast(text, type="ok") {
      const el = document.createElement("div");
      el.className = `fade-in rounded-xl px-4 py-3 shadow-dino flex items-start ${type==="error"?"bg-red-500/20 border border-red-400/40":"bg-darkCard border border-darkBorder"}`;
      el.innerHTML = `
        <i class="fa-solid ${type==="error"?"fa-triangle-exclamation text-red-400":"fa-circle-check text-darkPrimary"} mr-2 mt-0.5"></i>
        <div>${text}</div>
      `;
      $toast().appendChild(el);
      setTimeout(() => {
        el.style.opacity = 0;
        setTimeout(()=> el.remove(), 250);
      }, 2200);
    }

    function openModal(innerHTML) {
      $modal().innerHTML = `
        <div class="fixed inset-0 bg-black/70 flex items-end sm:items-center sm:justify-center z-[999] p-4">
          <div class="bg-darkCard w-full max-w-md rounded-2xl p-5 border border-darkBorder shadow-card max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-darkBgLight flex items-center justify-center hover:bg-darkCardHover">
              <i class="fa-solid fa-xmark"></i>
            </button>
            ${innerHTML}
          </div>
        </div>
      `;
      $modal().firstChild.addEventListener("click", (e)=>{
        if (e.target === e.currentTarget) closeModal();
      });
    }

    function closeModal(){ $modal().innerHTML = ""; }

    async function getUser(id) {
      if (state.usersCache[id]) return state.usersCache[id];
      const u = await api.get(`/users/${id}`);
      state.usersCache[id] = u;
      return u;
    }

    /*********************
     * Payments
     *********************/
    async function initiatePayment(paymentType, cost, kind, itemId = null, extra = {}) {
      try {
        const res = await api.post('/create-invoice', {paymentType, cost, kind, itemId, ...extra});
        if (!res.invoiceLink) throw new Error('No invoice link');
        Telegram.WebApp.openInvoice(res.invoiceLink, async (status) => {
          if (status === 'paid') {
            toast('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!');
            if (kind === 'post') await publishPostAfterPay();
            else if (kind === 'clients') await addClientsAfterPay(itemId, paymentType === 'stars' ? ECON.CLIENT_STARS.clients : ECON.CLIENT_TON.clients);
            renderIfTab(state.currentTab, currentRenderFn);
          } else if (status === 'failed') {
            toast('–û–ø–ª–∞—Ç–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å', 'error');
          }
        });
      } catch (e) {
        toast('–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞: ' + e.message, 'error');
      }
    }

    async function publishPostAfterPay() {
      const text = state.postDraft.trim();
      if (!text) return;
      await api.post('/posts', {text});
      state.postDraft = "";
      renderDinoNet();
    }

    async function addClientsAfterPay(itemId, numClients) {
      await api.post('/add-clients', {itemId, numClients});
      // Refresh details
    }

    /*********************
     * Random Modals
     *********************/
    function showInviteModal() {
      if (state.noInvite) return;
      const refLink = `https://t.me/dinosav_bot?start=ref-game-${state.user.id}`;
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞!</h2>
          <p>–ü–æ–ª—É—á–∏ ${fmt(ECON.REF_REWARD)} DINO –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ.</p>
          <div class="flex items-center justify-between bg-darkBgLight rounded-xl p-3">
            <div class="text-sm truncate">${refLink}</div>
            <button class="px-3 py-1.5 rounded-lg bg-darkPrimary/20 text-sm" onclick="copyText('${refLink}')">
              <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
          <button class="w-full py-3 rounded-xl bg-darkBgLight" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="w-full py-3 rounded-xl bg-darkDanger text-white" onclick="state.noInvite = true; saveLocal(); closeModal();">–ë–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</button>
        </div>
      `);
    }

    function showSubscribeModal() {
      if (state.noSubscribe) return;
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª!</h2>
          <p>–ë—É–¥—å –≤ –∫—É—Ä—Å–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π.</p>
          <a href="https://t.me/dinogamed" class="block py-3 rounded-xl bg-darkPrimary text-white text-center">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
          <button class="w-full py-3 rounded-xl bg-darkBgLight" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="w-full py-3 rounded-xl bg-darkDanger text-white" onclick="state.noSubscribe = true; saveLocal(); closeModal();">–ë–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å</button>
        </div>
      `);
    }

    /*********************
     * Theme Toggle
     *********************/
    function toggleTheme() {
      state.theme = state.theme === "dark" ? "light" : "dark";
      document.body.classList.remove("dark", "light");
      document.body.classList.add(state.theme);
      saveLocal();
      renderIfTab("profile", renderProfile);
    }

    /*********************
     * Game Loop
     *********************/
    async function syncEconomy(force = false) {
      if (!force && now() - state.lastSync < 30000) return;
      try {
        await api.post('/economy/sync', state.economy);
        state.lastSync = now();
      } catch (e) {
        console.error('Sync failed', e);
      }
    }

    function tick() {
      const dt = Math.max(0, Math.min(1, (now() - state.lastTick)/1000));
      state.lastTick = now();
      state.economy.balance += state.economy.dps * dt;
      updateHeader();

      if (state.economy.xp >= state.economy.xpNext) {
        state.economy.level++;
        state.economy.xp -= state.economy.xpNext;
        state.economy.xpNext = Math.round(state.economy.xpNext * 1.5);
        toast(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã ${state.economy.level} —É—Ä–æ–≤–Ω—è`);
        updateLevel();
      }

      syncEconomy();
      requestAnimationFrame(tick);
    }

    function updateHeader() {
      $balance().textContent = fmt(state.economy.balance);
      $dps().textContent = fmt(state.economy.dps);
      if (state.user) {
        $mobileUsername().textContent = state.user.username;
        $mobileAvatar().src = state.user.avatar;
      }
    }

    function updateLevel() {
      $level().textContent = state.economy.level;
      $xpText().textContent = `${Math.floor(state.economy.xp)}/${state.economy.xpNext}`;
    }

    /*********************
     * Navigation
     *********************/
    let currentRenderFn = null;
    function setTab(tab) {
      state.currentTab = tab;

      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active", "bg-darkCardHover"));
      const btn = document.querySelector(`.nav-btn[data-tab='${tab}']`);
      if (btn) btn.classList.add("active", "bg-darkCardHover");

      if (tab === "clicker") { currentRenderFn = renderClicker; renderClicker(); }
      if (tab === "dinonet") { currentRenderFn = renderDinoNet; renderDinoNet(); }
      if (tab === "business") { currentRenderFn = renderBusiness; renderBusiness(); }
      if (tab === "investments") { currentRenderFn = renderInvestments; renderInvestments(); }
      if (tab === "profile") { currentRenderFn = renderProfile; renderProfile(); }
    }

    function renderIfTab(tab, fn){ if (state.currentTab === tab) fn(); }

    /*********************
     * Clicker
     *********************/
    function renderClicker() {
      $content().innerHTML = `
        <section class="space-y-6">
          <div class="card p-5">
            <div class="flex items-center justify-between mb-4">
              <div>
                <div class="text-sm text-darkMuted">–î–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫</div>
                <div class="text-xl font-bold text-darkPrimary">${fmt(state.economy.perClick)} DINO</div>
              </div>
              <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="buyClick()">
                <i class="fa-solid fa-arrow-up mr-2"></i>+${ECON.CLICK_INC} –∑–∞ ${fmt(state.economy.clickUpgradeCost)}
              </button>
            </div>
            <div class="text-xs text-darkMuted">–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤: ${state.clicks}</div>
          </div>

          <div id="click-area" class="card p-8 text-center active:scale-[.995] transition cursor-pointer relative overflow-hidden">
            <div class="text-8xl mb-2 select-none leading-none animate-float">ü¶ñ</div>
            <div class="text-lg font-medium mb-1">–ö–ª–∏–∫–∞–π –ø–æ –¥–∏–Ω–æ–∑–∞–≤—Ä—É</div>
            <div class="text-sm text-darkMuted">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π DINO –∏ —É–ª—É—á—à–∞–π —Å–≤–æ—é —ç–∫–æ–Ω–æ–º–∏–∫—É</div>
          </div>
        </section>
      `;

      document.getElementById("click-area").addEventListener("click", async (e) => {
        const inc = state.economy.perClick;
        state.economy.balance += inc;
        state.clicks++;
        state.economy.xp += 0.1;
        updateHeader();
        updateLevel();
        saveLocal();
        await syncEconomy(true);

        const coin = document.createElement("div");
        coin.className = "coin-pop absolute text-darkSecondary font-medium z-10";
        coin.style.left = (e.offsetX - 10) + "px";
        coin.style.top = (e.offsetY - 10) + "px";
        coin.textContent = `+${inc.toFixed(2)}`;
        e.currentTarget.appendChild(coin);
        setTimeout(() => coin.remove(), 600);
      });
    }

    async function buyClick() {
      if (state.economy.balance < state.economy.clickUpgradeCost) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO", "error");
      try {
        const res = await api.post('/economy/upgrade-click', {});
        Object.assign(state.economy, res);
        toast("–£–ª—É—á—à–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ!");
        updateHeader();
        updateLevel();
        renderClicker();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    /*********************
     * DinoNet
     *********************/
    let dinonetTab = "feed";
    async function renderDinoNet() {
      const posts = await api.get('/posts');
      $content().innerHTML = `
        <section class="space-y-5">
          <div class="card p-2">
            <div class="grid grid-cols-2 gap-2">
              <button class="tab-btn ${dinonetTab==='feed'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('feed')">
                <i class="fa-solid fa-rss mr-2"></i>–õ–µ–Ω—Ç–∞
              </button>
              <button class="tab-btn ${dinonetTab==='myposts'?'active':''} rounded-xl py-3 font-medium" onclick="setDinoNetTab('myposts')">
                <i class="fa-solid fa-file-lines mr-2"></i>–ú–æ–∏
              </button>
            </div>
          </div>

          ${dinonetTab==='feed' ? await feedPanelHTML(posts) : await myPostsPanelHTML(posts)}
        </section>
      `;
    }

    function setDinoNetTab(t){ dinonetTab=t; renderDinoNet(); }

    async function feedPanelHTML(posts) {
      const filteredPosts = posts;
      return `
        <div class="space-y-5">
          <div class="card p-5">
            <div class="flex gap-3 mb-4">
              <img src="${state.user.avatar}" class="w-12 h-12 rounded-full border-2 border-darkPrimary" />
              <div class="flex-1">
                <textarea id="post-text" rows="2" class="w-full bg-darkBgLight border border-darkBorder rounded-xl p-3 outline-none resize-none text-sm" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ –º–∏—Ä–µ –¥–∏–Ω–æ–∑–∞–≤—Ä–æ–≤?">${state.postDraft}</textarea>
              </div>
            </div>
            <div class="flex items-center justify-end">
              <button class="px-4 py-2 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="openPublishModal()">
                <i class="fa-solid fa-paper-plane mr-2"></i>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
              </button>
            </div>
          </div>

          <div class="space-y-4" id="post-feed">
            ${filteredPosts.slice().sort((a,b)=>b.createdAt-a.createdAt).map(p=>postItemHTML(p)).join("") || '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p></div>'}
          </div>
        </div>
      `;
    }

    async function myPostsPanelHTML(posts) {
      const myPosts = posts.filter(p => p.authorId === state.user.id).sort((a,b)=>b.createdAt-a.createdAt);
      return `
        <div class="space-y-4">
          ${myPosts.map(p=>postItemHTML(p, true)).join("") || '<div class="text-center py-10"><i class="fa-regular fa-comment-dots text-4xl text-darkMuted mb-3"></i><p>–ù–µ—Ç –≤–∞—à–∏—Ö –ø–æ—Å—Ç–æ–≤</p></div>'}
        </div>
      `;
    }

    function postItemHTML(p, isMy = false){
      const dt = new Date(p.createdAt).toLocaleString();
      const author = p.author;
      const usernameHTML = author.showInDinoNet ? `<span class="text-sm text-darkMuted">@${author.username}</span>` : '';
      const moreBtn = p.text.length > 100 ? `<button id="more_${p.id}" onclick="togglePostExpand('${p.id}')" class="text-darkPrimary text-sm mt-1">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>` : '';
      const deleteBtn = (state.isAdmin || (isMy && p.authorId === state.user.id)) ? `
        <button onclick="deletePost('${p.id}')" class="flex items-center text-darkMuted hover:text-red-400 ml-auto">
          <i class="fa-regular fa-trash-can mr-1.5"></i>–£–¥–∞–ª–∏—Ç—å
        </button>
      ` : '';

      return `
        <article id="post_${p.id}" class="card p-5 fade-in">
          <div class="flex items-start gap-3 mb-3">
            <img src="${author.avatar}" class="w-10 h-10 rounded-full" />
            <div class="flex-1">
              <div class="flex items-center justify-between mb-1">
                <div class="font-semibold cursor-pointer" onclick="openProfile('${p.authorId}')">${author.name} ${usernameHTML}</div>
                <div class="text-xs text-darkMuted">${dt}</div>
              </div>
              <div class="mt-2 whitespace-pre-wrap text-sm post-text">${escapeHtml(p.text)}</div>
              ${moreBtn}
            </div>
          </div>
          <div class="flex items-center gap-4 text-sm border-t border-darkBorder pt-3">
            <button onclick="likePost('${p.id}')" class="flex items-center text-darkMuted hover:text-darkSecondary">
              <i class="fa-${p.likedBy.includes(state.user.id) ? 'solid' : 'regular'} fa-heart mr-1.5"></i>${p.likes}
            </button>
            <div class="flex items-center text-darkMuted">
              <i class="fa-regular fa-eye mr-1.5"></i>${p.views}
            </div>
            ${deleteBtn}
          </div>
        </article>
      `;
    }

    function togglePostExpand(id) {
      const post = document.getElementById(`post_${id}`);
      post.classList.toggle('post-expanded');
      const btn = document.getElementById(`more_${id}`);
      btn.textContent = post.classList.contains('post-expanded') ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
    }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    function openPublishModal() {
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç</h2>
          <p class="text-sm text-darkMuted">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmt(ECON.POST_COST_DINO)} DINO –∏–ª–∏ ${ECON.POST_COST_STARS} –∑–≤—ë–∑–¥</p>
          <button class="w-full py-3 rounded-xl bg-darkPrimary text-white" onclick="publishPostDino()">
            –û–ø–ª–∞—Ç–∏—Ç—å DINO
          </button>
          <button class="w-full py-3 rounded-xl bg-darkSecondary text-white" onclick="publishPostStars()">
            –û–ø–ª–∞—Ç–∏—Ç—å –∑–≤—ë–∑–¥–∞–º–∏
          </button>
        </div>
      `);
      state.postDraft = document.getElementById('post-text').value;
    }

    async function publishPostDino() {
      if (state.economy.balance < ECON.POST_COST_DINO) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç DINO", "error");
      try {
        const text = state.postDraft.trim();
        if (!text) return toast("–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç", "error");
        const res = await api.post('/posts/pay-dino', {text});
        state.economy.balance -= ECON.POST_COST_DINO;
        state.postDraft = "";
        closeModal();
        renderDinoNet();
        toast("–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    function publishPostStars() {
      initiatePayment('stars', ECON.POST_COST_STARS, 'post');
      closeModal();
    }

    async function likePost(id){
      try {
        await api.post(`/posts/${id}/like`);
        renderDinoNet();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function deletePost(id){
      try {
        await api.post(`/posts/${id}/delete`);
        renderDinoNet();
        toast("–ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    /*********************
     * Business
     *********************/
    let businessTab = "companies";
    async function renderBusiness() {
      $content().innerHTML = `
        <section class="space-y-5">
          <div class="card p-2">
            <div class="grid grid-cols-3 gap-2">
              <button class="tab-btn ${businessTab==='companies'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('companies')">
                <i class="fa-solid fa-building mr-2"></i>–ë–∏–∑–Ω–µ—Å
              </button>
              <button class="tab-btn ${businessTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('crypto')">
                <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
              </button>
              <button class="tab-btn ${businessTab==='referrals'?'active':''} rounded-xl py-3 font-medium" onclick="setBusinessTab('referrals')">
                <i class="fa-solid fa-link mr-2"></i>–†–µ—Ñ–µ—Ä–∞–ª—ã
              </button>
            </div>
          </div>

          ${businessTab==='companies' ? await companiesPanelHTML() : businessTab==='crypto' ? await cryptoPanelHTML() : await referralsPanelHTML()}
        </section>
      `;
    }

    function setBusinessTab(t){ businessTab=t; renderBusiness(); }

    async function companiesPanelHTML(){
      const companies = await api.get('/companies/my');
      return `
        <div class="space-y-5">
          <div class="card p-5">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-semibold text-lg mb-1">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h3>
                <p class="text-sm text-darkMuted">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ. –ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º.</p>
              </div>
              <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="openCreateCompany()">
                <i class="fa-solid fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>

          <div>
            <h3 class="font-semibold text-lg mb-4 flex items-center">
              <i class="fa-solid fa-building-user mr-2"></i>–ú–æ–∏ –∫–æ–º–ø–∞–Ω–∏–∏
            </h3>
            <div class="space-y-4">
              ${companies.length ? companies.map(co => `
                <div class="card p-5 cursor-pointer relative" onclick="openCompanyDetails('${co.id}')">
                  <div class="flex items-center mb-2">
                    <div class="font-bold text-lg mb-1">${co.name} (${co.ticker})</div>
                  </div>
                  <div class="text-sm text-darkMuted">–ö–ª–∏–µ–Ω—Ç—ã: ${co.clients} | –¶–µ–Ω–∞ –∞–∫—Ü–∏–∏: ${fmt(co.price)}</div>
                  ${state.isAdmin ? `<button class="absolute top-2 right-2 text-red-400" onclick="event.stopPropagation(); deleteCompany('${co.id}')"><i class="fa-regular fa-trash-can"></i></button>` : ''}
                </div>
              `).join("") : '<div class="text-center py-10 card"><i class="fa-regular fa-building text-4xl text-darkMuted mb-3"></i><p>–ï—â—ë –Ω–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π</p></div>'}
            </div>
          </div>
        </div>
      `;
    }

    function openCreateCompany(){
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold mb-2">–ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è</h2>
          <p class="text-sm text-red-400">–ù–µ –ø–∏—à–∏—Ç–µ –Ω–∏—á–µ–≥–æ –ø–ª–æ—Ö–æ–≥–æ. –ú—ã –Ω–µ –Ω–µ—Å–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ú—ã –∑–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.</p>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
              <input id="newco_name" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DinoSoft">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">–¢–∏–∫–µ—Ä (–∞–∫—Ä–æ–Ω–∏–º)</label>
              <input id="newco_ticker" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DINO" maxlength="6">
            </div>
          </div>
          <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium mt-2" onclick="createCompany()">
            –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
          </button>
          <p class="text-xs text-darkMuted mt-3">–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–ø—É—Å–∫–∞–µ—Ç—Å—è 1000 –∞–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥–∞—é—Ç –≤ –≤–∞—à –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å.</p>
        </div>
      `);
    }

    async function createCompany(){
      const name = document.getElementById("newco_name").value.trim();
      const ticker = document.getElementById("newco_ticker").value.trim().replace(/[^A-Z0-9]/g,"").slice(0,6).toUpperCase();
      if (!name || !ticker) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Ç–∏–∫–µ—Ä", "error");

      try {
        const co = await api.post('/companies', {name, ticker});
        closeModal();
        renderBusiness();
        toast("–ö–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!");
        showRefLinkModal(co.id, 'company', name);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    function showRefLinkModal(id, type, name) {
      const refLink = `https://t.me/dinosav_bot?start=ref-${type === 'company' ? '' : 'coin-'}${id}`;
      const msg = type === 'company' ? '–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –æ–Ω–∏ –∫—É–ø–∏–ª–∏ —Ç–≤–æ–∏ –∞–∫—Ü–∏–∏' : '–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –æ–Ω–∏ —Å—Ç–∞–ª–∏ —Ç–≤–æ–∏–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏';
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold">–°—Å—ã–ª–∫–∞ –Ω–∞ ${name}</h2>
          <p>${msg}</p>
          <div class="flex items-center justify-between bg-darkBgLight rounded-xl p-3">
            <div class="text-sm truncate">${refLink}</div>
            <button class="px-3 py-1.5 rounded-lg bg-darkPrimary/20 text-sm" onclick="copyText('${refLink}')">
              <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
      `);
    }

    async function openCompanyDetails(id) {
      try {
        const c = await api.get(`/companies/${id}`);
        const owner = await getUser(c.ownerId);
        const ownerName = owner.hideInInvest ? '–ê–Ω–æ–Ω–∏–º–Ω–æ' : `@${owner.username}`;
        const avail = c.totalIssued - c.soldShares;
        const canEmit = c.initialShares + c.clients*10 - c.totalIssued;
        const ref = `https://t.me/dinosav_bot?start=ref-${id}`;
        const deleteBtn = state.isAdmin || c.ownerId === state.user.id ? `<button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mt-4" onclick="deleteCompany('${id}')">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>` : '';
        openModal(`
          <div class="space-y-4">
            <h2 class="font-bold text-xl mb-1">${c.name} (${c.ticker})</h2>
            <p class="text-sm text-darkMuted">–í–ª–∞–¥–µ–ª–µ—Ü: ${ownerName}</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–ö–ª–∏–µ–Ω—Ç—ã</div>
                <div class="font-semibold text-lg">${c.clients}</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–¶–µ–Ω–∞ –∞–∫—Ü–∏–∏</div>
                <div class="font-semibold text-lg text-darkPrimary">${fmt(c.price)}</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –∞–∫—Ü–∏–π</div>
                <div class="font-semibold text-lg">${avail}</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–î–æ—Ö–æ–¥ –æ—Ç –ø—Ä–æ–¥–∞–∂</div>
                <div class="font-semibold text-lg">${fmt(c.revenue)}</div>
              </div>
            </div>
            <div class="flex items-center justify-between bg-darkBgLight rounded-xl p-3 mb-4">
              <div class="text-sm truncate"><span class="text-darkMuted">–†–µ—Ñ. —Å—Å—ã–ª–∫–∞: </span><span>${ref}</span></div>
              <button class="px-3 py-1.5 rounded-lg bg-darkPrimary/20 hover:bg-darkPrimary/30 text-sm" onclick="copyText('${ref}')">
                <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3">
              <div class="font-semibold mb-2 flex items-center"><i class="fa-solid fa-print mr-2 text-darkSecondary"></i>–≠–º–∏—Å—Å–∏—è –∞–∫—Ü–∏–π</div>
              <div class="text-xs text-darkMuted mb-2">–î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–ø—É—Å–∫—É: ${canEmit} –∞–∫—Ü–∏–π</div>
              <div class="flex items-center gap-2">
                <input id="emi_${c.id}" type="number" min="1" class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                <button class="px-3 py-2 rounded-lg bg-darkPrimary hover:bg-darkPrimaryHover text-white" onclick="emitShares('${c.id}')">
                  –í—ã–ø—É—Å—Ç–∏—Ç—å
                </button>
              </div>
              <div class="text-xs text-darkSecondary mt-1">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${ECON.EMISSION_COST_PER_SHARE} DINO/–∞–∫—Ü–∏—è</div>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3">
              <div class="font-semibold mb-2 flex items-center"><i class="fa-solid fa-users mr-2 text-darkPrimary"></i>–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
              <div class="text-xs text-darkMuted mb-2">–ü–æ–∫—É–ø–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã –∞–∫—Ü–∏–π</div>
              <div class="grid grid-cols-1 gap-2">
                <button class="px-3 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white flex items-center justify-center" onclick="buyClientDino('${c.id}')">
                  <i class="fa-solid fa-user-plus mr-2"></i>+1 –∑–∞ ${fmt(ECON.CLIENT_COST_DINO)} DINO
                </button>
                <button class="px-3 py-2.5 rounded-xl bg-darkSecondary hover:bg-darkSecondary text-white flex items-center justify-center" onclick="buyClientsStars('${c.id}', 'company')">
                  <i class="fa-solid fa-star mr-2"></i>+${ECON.CLIENT_STARS.clients} –∑–∞ ${ECON.CLIENT_STARS.cost} –∑–≤—ë–∑–¥
                </button>
                <button class="px-3 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center" onclick="buyClientsTon('${c.id}', 'company')">
                  <i class="fa-solid fa-coins mr-2"></i>+${ECON.CLIENT_TON.clients} –∑–∞ ${ECON.CLIENT_TON.cost} TON
                </button>
              </div>
            </div>
            ${deleteBtn}
          </div>
        `);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function deleteCompany(id) {
      if (!confirm('–£–≤–µ—Ä–µ–Ω—ã?')) return;
      try {
        await api.post(`/companies/${id}/delete`);
        closeModal();
        renderBusiness();
        toast("–ö–æ–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function emitShares(id){
      const input = document.getElementById(`emi_${id}`);
      const n = parseInt(input.value || "0");
      if (n < 1) return toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "error");
      try {
        const res = await api.post(`/companies/${id}/emit`, {amount: n});
        state.economy.balance = res.balance;
        closeModal();
        openCompanyDetails(id);
        toast(`–í—ã–ø—É—â–µ–Ω–æ ${n} –∞–∫—Ü–∏–π`);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function buyClientDino(id){
      try {
        const res = await api.post(`/companies/${id}/buy-client-dino`);
        state.economy.balance = res.balance;
        closeModal();
        openCompanyDetails(id);
        toast("+1 –∫–ª–∏–µ–Ω—Ç");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    function buyClientsStars(id, type) {
      initiatePayment('stars', ECON.CLIENT_STARS.cost, 'clients', id, {itemType: type});
    }

    function buyClientsTon(id, type) {
      initiatePayment('ton', ECON.CLIENT_TON.cost, 'clients', id, {itemType: type});
    }

    async function cryptoPanelHTML(){
      const cryptos = await api.get('/cryptos/my');
      return `
        <div class="space-y-5">
          <div class="card p-5">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="font-semibold text-lg mb-1">–°–æ–∑–¥–∞—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É</h3>
                <p class="text-sm text-darkMuted">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${fmt(ECON.CRYPTO_DINO_COST)} DINO</p>
              </div>
              <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium flex items-center" onclick="openCreateCrypto()">
                <i class="fa-solid fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å
              </button>
            </div>
          </div>

          <div>
            <h3 class="font-semibold text-lg mb-4 flex items-center">
              <i class="fa-solid fa-coins mr-2"></i>–ú–æ–∏ —Ç–æ–∫–µ–Ω—ã
            </h3>
            <div class="space-y-4">
              ${cryptos.length ? cryptos.map(co => `
                <div class="card p-5 cursor-pointer relative" onclick="openCryptoDetails('${co.id}')">
                  <div class="flex items-center mb-2">
                    <div class="font-bold text-lg mb-1">${co.name} (${co.ticker})</div>
                  </div>
                  <div class="text-sm text-darkMuted">–ò–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤: ${co.investors} | –¶–µ–Ω–∞: ${fmt(co.price)}</div>
                  ${state.isAdmin ? `<button class="absolute top-2 right-2 text-red-400" onclick="event.stopPropagation(); deleteCrypto('${co.id}')"><i class="fa-regular fa-trash-can"></i></button>` : ''}
                </div>
              `).join("") : '<div class="text-center py-10 card"><i class="fa-regular fa-coins text-4xl text-darkMuted mb-3"></i><p>–ï—â—ë –Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤</p></div>'}
            </div>
          </div>
        </div>
      `;
    }

    function openCreateCrypto(){
      openModal(`
        <div class="space-y-4">
          <h2 class="text-xl font-bold mb-2">–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞</h2>
          <p class="text-sm text-red-400">–ù–µ –ø–∏—à–∏—Ç–µ –Ω–∏—á–µ–≥–æ –ø–ª–æ—Ö–æ–≥–æ. –ú—ã –Ω–µ –Ω–µ—Å–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ú—ã –∑–∞ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏.</p>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="coin_name" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="Dino Coin">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">–¢–∏–∫–µ—Ä</label>
              <input id="coin_ticker" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="DNX" maxlength="6">
            </div>
          </div>
          <button class="w-full py-3 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white font-medium mt-2" onclick="createCrypto()">
            –°–æ–∑–¥–∞—Ç—å –∑–∞ ${fmt(ECON.CRYPTO_DINO_COST)} DINO
          </button>
          <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-3 mt-3">
            <div class="flex items-start">
              <i class="fa-solid fa-triangle-exclamation text-amber-400 mr-2 mt-0.5"></i>
              <div class="text-xs text-amber-200">–í—ã–ø—É—Å–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ${ECON.CRYPTO_SUPPLY_LIMIT}.</div>
            </div>
          </div>
        </div>
      `);
    }

    async function createCrypto(){
      const name = document.getElementById("coin_name").value.trim();
      const ticker = document.getElementById("coin_ticker").value.trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,6);
      if (!name || !ticker) return toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–∏–∫–µ—Ä", "error");

      try {
        const coin = await api.post('/cryptos', {name, ticker});
        state.economy.balance -= ECON.CRYPTO_DINO_COST;
        closeModal();
        renderBusiness();
        toast("–¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω!");
        showRefLinkModal(coin.id, 'crypto', name);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function openCryptoDetails(id) {
      try {
        const co = await api.get(`/cryptos/${id}`);
        const owner = await getUser(co.createdBy);
        const ownerName = owner.hideInInvest ? '–ê–Ω–æ–Ω–∏–º–Ω–æ' : `@${owner.username}`;
        const ref = `https://t.me/dinosav_bot?start=ref-coin-${co.id}`;
        const canEmit = ECON.CRYPTO_SUPPLY_LIMIT - co.totalSupply;
        const deleteBtn = state.isAdmin || co.createdBy === state.user.id ? `<button class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium mt-4" onclick="deleteCrypto('${co.id}')">–£–¥–∞–ª–∏—Ç—å –∫—Ä–∏–ø—Ç—É</button>` : '';
        openModal(`
          <div class="space-y-4">
            <h2 class="font-bold text-xl mb-1">${co.name} (${co.ticker})</h2>
            <p class="text-sm text-darkMuted">–í–ª–∞–¥–µ–ª–µ—Ü: ${ownerName}</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–¶–µ–Ω–∞</div>
                <div class="font-semibold text-lg text-darkPrimary">${fmt(co.price)} DINO</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–ò–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤</div>
                <div class="font-semibold text-lg">${co.investors}</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–û–±—â–∏–π –≤—ã–ø—É—Å–∫</div>
                <div class="font-semibold text-lg">${co.totalSupply}</div>
              </div>
              <div class="bg-darkBgLight rounded-xl p-3">
                <div class="text-darkMuted text-sm mb-1">–î–æ—Å—Ç—É–ø–Ω–æ –∫ –≤—ã–ø—É—Å–∫—É</div>
                <div class="font-semibold text-lg">${canEmit}</div>
              </div>
            </div>
            <div class="flex items-center justify-between bg-darkBgLight rounded-xl p-3 mb-4">
              <div class="text-sm truncate"><span class="text-darkMuted">–†–µ—Ñ. —Å—Å—ã–ª–∫–∞: </span><span>${ref}</span></div>
              <button class="px-3 py-1.5 rounded-lg bg-darkPrimary/20 hover:bg-darkPrimary/30 text-sm" onclick="copyText('${ref}')">
                <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3">
              <div class="font-semibold mb-2 flex items-center"><i class="fa-solid fa-coins mr-2 text-darkSecondary"></i>–≠–º–∏—Å—Å–∏—è —Ç–æ–∫–µ–Ω–æ–≤</div>
              <div class="text-xs text-darkMuted mb-2">–î–æ—Å—Ç—É–ø–Ω–æ: ${canEmit}</div>
              <div class="flex items-center gap-2">
                <input id="emi_crypto_${co.id}" type="number" min="1" class="flex-1 bg-darkCard border border-darkBorder rounded-lg px-3 py-2" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                <button class="px-3 py-2 rounded-lg bg-darkPrimary hover:bg-darkPrimaryHover text-white" onclick="emitCrypto('${co.id}')">
                  –í—ã–ø—É—Å—Ç–∏—Ç—å
                </button>
              </div>
              <div class="text-xs text-darkSecondary mt-1">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${ECON.EMISSION_COST_PER_SHARE} DINO/—Ç–æ–∫–µ–Ω</div>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3">
              <div class="font-semibold mb-2 flex items-center"><i class="fa-solid fa-users mr-2 text-darkPrimary"></i>–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
              <div class="text-xs text-darkMuted mb-2">–ü–æ–∫—É–ø–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã</div>
              <div class="grid grid-cols-1 gap-2">
                <button class="px-3 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white flex items-center justify-center" onclick="buyClientDino('${co.id}')">
                  <i class="fa-solid fa-user-plus mr-2"></i>+1 –∑–∞ ${fmt(ECON.CLIENT_COST_DINO)} DINO
                </button>
                <button class="px-3 py-2.5 rounded-xl bg-darkSecondary hover:bg-darkSecondary text-white flex items-center justify-center" onclick="buyClientsStars('${co.id}', 'crypto')">
                  <i class="fa-solid fa-star mr-2"></i>+${ECON.CLIENT_STARS.clients} –∑–∞ ${ECON.CLIENT_STARS.cost} –∑–≤—ë–∑–¥
                </button>
                <button class="px-3 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center" onclick="buyClientsTon('${co.id}', 'crypto')">
                  <i class="fa-solid fa-coins mr-2"></i>+${ECON.CLIENT_TON.clients} –∑–∞ ${ECON.CLIENT_TON.cost} TON
                </button>
              </div>
            </div>
            <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-3">
              <div class="flex items-start">
                <i class="fa-solid fa-triangle-exclamation text-amber-400 mr-2 mt-0.5"></i>
                <div class="text-xs text-amber-200">–í–Ω–∏–º–∞–Ω–∏–µ: –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ —Å–æ–ø—Ä—è–∂–µ–Ω—ã —Å –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º.</div>
              </div>
            </div>
            ${deleteBtn}
          </div>
        `);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function deleteCrypto(id) {
      if (!confirm('–£–≤–µ—Ä–µ–Ω—ã?')) return;
      try {
        await api.post(`/cryptos/${id}/delete`);
        closeModal();
        renderBusiness();
        toast("–ö—Ä–∏–ø—Ç–∞ —É–¥–∞–ª–µ–Ω–∞");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function emitCrypto(id){
      const input = document.getElementById(`emi_crypto_${id}`);
      const n = parseInt(input.value || "0");
      if (n < 1) return toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "error");
      try {
        const res = await api.post(`/cryptos/${id}/emit`, {amount: n});
        state.economy.balance = res.balance;
        closeModal();
        openCryptoDetails(id);
        toast(`–í—ã–ø—É—â–µ–Ω–æ ${n} —Ç–æ–∫–µ–Ω–æ–≤`);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function referralsPanelHTML() {
      const referrals = await api.get('/referrals');
      const refLink = `https://t.me/dinosav_bot?start=ref-game-${state.user.id}`;
      return `
        <div class="space-y-5">
          <div class="card p-5">
            <h3 class="font-semibold text-lg mb-4">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
            <p class="text-sm text-darkMuted mb-4">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ ${fmt(ECON.REF_REWARD)} DINO –∑–∞ –∫–∞–∂–¥–æ–≥–æ!</p>
            <div class="flex items-center justify-between bg-darkBgLight rounded-xl p-3 mb-4">
              <div class="text-sm truncate"><span class="text-darkMuted">–í–∞—à–∞ —Ä–µ—Ñ. —Å—Å—ã–ª–∫–∞: </span><span>${refLink}</span></div>
              <button class="px-3 py-1.5 rounded-lg bg-darkPrimary/20 hover:bg-darkPrimary/30 text-sm" onclick="copyText('${refLink}')">
                <i class="fa-regular fa-copy mr-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
              </button>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3 mb-4">
              <div class="text-darkMuted text-sm mb-1">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª</div>
              <a href="https://t.me/dinogamed" class="text-darkPrimary">–ß—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π</a>
            </div>
            <div class="bg-darkBgLight rounded-xl p-3">
              <div class="text-darkMuted text-sm mb-1">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
              <div class="font-semibold text-lg">${referrals.count}</div>
            </div>
          </div>
        </div>
      `;
    }

    /*********************
     * Investments
     *********************/
    let invTab = "stocks";
    async function renderInvestments(){
      $content().innerHTML = `
        <section class="space-y-5">
          <div class="card p-2">
            <div class="grid grid-cols-3 gap-2">
              <button class="tab-btn ${invTab==='stocks'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('stocks')">
                <i class="fa-solid fa-chart-line mr-2"></i>–ê–∫—Ü–∏–∏
              </button>
              <button class="tab-btn ${invTab==='crypto'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('crypto')">
                <i class="fa-solid fa-coins mr-2"></i>–ö—Ä–∏–ø—Ç–∞
              </button>
              <button class="tab-btn ${invTab==='wallet'?'active':''} rounded-xl py-3 font-medium" onclick="setInvTab('wallet')">
                <i class="fa-solid fa-wallet mr-2"></i>–ö–æ—à–µ–ª—ë–∫
              </button>
            </div>
          </div>

          ${invTab==='stocks' ? await stocksMarketHTML() : invTab==='crypto' ? await cryptoMarketHTML() : await walletHTML()}
        </section>
      `;
      const searchInput = document.getElementById('search-inv');
      if (searchInput) searchInput.addEventListener('input', (e) => filterInv(e.target.value));
    }

    function setInvTab(t){ invTab=t; renderInvestments(); }

    function filterInv(query) {
      query = query.toLowerCase();
      const cards = document.querySelectorAll('.inv-card');
      cards.forEach(card => {
        const title = card.querySelector('.inv-title')?.textContent.toLowerCase() || '';
        card.style.display = title.includes(query) ? '' : 'none';
      });
    }

    async function stocksMarketHTML(){
      let companies = await api.get('/companies');
      companies = companies.sort((a,b) => b.clients - a.clients);
      if (!companies.length) return `<div class="card p-5 text-center py-10"><i class="fa-regular fa-building text-4xl text-darkMuted mb-3"></i><p>–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –Ω–∞ —Ä—ã–Ω–∫–µ</p></div>`;
      return `
        <div class="space-y-4">
          <input id="search-inv" type="text" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–∏–∫–µ—Ä—É">
          ${companies.map(c=>{
            const isOwn = c.ownerId === state.user.id;
            const ownClass = isOwn ? 'border-darkSecondary border-2' : '';
            const ownText = isOwn ? '<span class="pill ml-2">–í–∞—à –±–∏–∑–Ω–µ—Å</span>' : '';
            const deleteBtn = state.isAdmin ? `<button class="absolute top-2 right-2 text-red-400" onclick="event.stopPropagation(); deleteCompany('${c.id}')"><i class="fa-regular fa-trash-can"></i></button>` : '';
            return `
              <div class="inv-card card p-5 ${ownClass} relative" onclick="openCompanyDetails('${c.id}')">
                <div class="flex items-center justify-between mb-4">
                  <div class="inv-title font-semibold">${c.name} (${c.ticker})${ownText}</div>
                  <div class="text-lg font-bold text-darkPrimary">–¶–µ–Ω–∞: ${fmt(c.price)}</div>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4 text-sm">
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–ö–ª–∏–µ–Ω—Ç—ã</div>
                    <div class="font-semibold">${c.clients}</div>
                  </div>
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                    <div class="font-semibold">${c.availShares}</div>
                  </div>
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–í–∞—à–∏ –∞–∫—Ü–∏–∏</div>
                    <div class="font-semibold">${c.holding}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <input id="buy_${c.id}" type="number" min="1" class="flex-1 bg-darkBgLight border border-darkBorder rounded-xl px-3 py-2" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                  <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white" onclick="event.stopPropagation(); buyStock('${c.id}')">
                    –ö—É–ø–∏—Ç—å
                  </button>
                </div>
                ${deleteBtn}
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    async function buyStock(id){
      const qty = parseInt(document.getElementById(`buy_${id}`).value || "0");
      if (qty < 1) return toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "error");
      try {
        const res = await api.post(`/stocks/buy`, {companyId: id, qty});
        state.economy.balance = res.balance;
        toast(`–ö—É–ø–ª–µ–Ω–æ ${qty} –∞–∫—Ü–∏–π`);
        updateHeader();
        renderInvestments();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function cryptoMarketHTML(){
      let cryptos = await api.get('/cryptos');
      cryptos = cryptos.sort((a,b) => b.investors - a.investors);
      if (!cryptos.length) return `<div class="card p-5 text-center py-10"><i class="fa-regular fa-coins text-4xl text-darkMuted mb-3"></i><p>–ù–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Ä—ã–Ω–∫–µ</p></div>`;
      return `
        <div class="space-y-4">
          <input id="search-inv" type="text" class="w-full bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–∏–∫–µ—Ä—É">
          ${cryptos.map(co=>{
            const isOwn = co.createdBy === state.user.id;
            const ownClass = isOwn ? 'border-darkSecondary border-2' : '';
            const ownText = isOwn ? '<span class="pill ml-2">–í–∞—à–∞ –∫—Ä–∏–ø—Ç–∞</span>' : '';
            const dpsText = `<div class="text-sm text-darkPrimary mt-2">–î–æ—Ö–æ–¥: ${fmt(co.dpsRate)} DINO/—Å–µ–∫ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</div>`;
            const deleteBtn = state.isAdmin ? `<button class="absolute top-2 right-2 text-red-400" onclick="event.stopPropagation(); deleteCrypto('${co.id}')"><i class="fa-regular fa-trash-can"></i></button>` : '';
            return `
              <div class="inv-card card p-5 ${ownClass} relative" onclick="openCryptoDetails('${co.id}')">
                <div class="flex items-center justify-between mb-4">
                  <div class="inv-title font-semibold">${co.name} (${co.ticker})${ownText}</div>
                  <div class="text-lg font-bold text-darkPrimary">–¶–µ–Ω–∞: ${fmt(co.price)} DINO</div>
                </div>
                <div class="grid grid-cols-3 gap-3 mb-4 text-sm">
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–ò–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤</div>
                    <div class="font-semibold">${co.investors}</div>
                  </div>
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–í–∞—à–∏ —Ç–æ–∫–µ–Ω—ã</div>
                    <div class="font-semibold">${fmt(co.holding, 4)}</div>
                  </div>
                  <div class="bg-darkBgLight rounded-xl p-3">
                    <div class="text-darkMuted mb-1">–†–∏—Å–∫</div>
                    <div class="font-semibold text-darkSecondary">–í—ã—Å–æ–∫–∏–π</div>
                  </div>
                </div>
                ${dpsText}
                <div class="flex items-center gap-2 mt-2">
                  <input id="cbuy_${co.id}" type="number" min="0.0001" step="0.0001" class="flex-1 bg-darkBgLight border border-darkBorder rounded-xl px-3 py-2" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                  <button class="px-4 py-2.5 rounded-xl bg-darkPrimary hover:bg-darkPrimaryHover text-white" onclick="event.stopPropagation(); buyCrypto('${co.id}')">
                    –ö—É–ø–∏—Ç—å
                  </button>
                </div>
                <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-3 mt-4">
                  <div class="flex items-start">
                    <i class="fa-solid fa-triangle-exclamation text-amber-400 mr-2 mt-0.5"></i>
                    <div class="text-xs text-amber-200">–¶–µ–Ω–∞ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞.</div>
                  </div>
                </div>
                ${deleteBtn}
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    async function buyCrypto(id){
      const amount = parseFloat(document.getElementById(`cbuy_${id}`).value || "0");
      if (amount <= 0) return toast("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ", "error");
      try {
        const res = await api.post(`/cryptos/buy`, {cryptoId: id, amount});
        state.economy.balance = res.balance;
        toast("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞");
        updateHeader();
        renderInvestments();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function walletHTML(){
      const wallet = await api.get('/wallet');
      const stockRows = wallet.stocks.map(pos => {
        const pnl = pos.pnl;
        const pnlPercent = pos.pnlPercent;
        return `
          <div class="bg-darkBgLight rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="font-semibold">${pos.ticker}</div>
              <div class="text-sm text-darkMuted">${pos.name}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-darkMuted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div class="font-semibold">${pos.shares}</div>
              </div>
              <div>
                <div class="text-darkMuted">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                <div class="font-semibold">${fmt(pos.avgPrice)}</div>
              </div>
              <div>
                <div class="text-darkMuted">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                <div class="font-semibold">${fmt(pos.currentPrice)}</div>
              </div>
              <div>
                <div class="text-darkMuted">P/L</div>
                <div class="font-semibold ${pnl>=0?'text-emerald-400':'text-red-400'}">
                  ${fmt(pnl)} (${fmt(pnlPercent)}%)
                </div>
              </div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white mt-2 w-full" onclick="sellStock('${pos.id}')">–ü—Ä–æ–¥–∞—Ç—å</button>
          </div>
        `;
      }).join("");

      const cryptoRows = wallet.crypto.map(pos => {
        const pnl = pos.pnl;
        const pnlPercent = pos.pnlPercent;
        return `
          <div class="bg-darkBgLight rounded-xl p-4 mt-4">
            <div class="flex items-center justify-between mb-3">
              <div class="font-semibold">${pos.ticker}</div>
              <div class="text-sm text-darkMuted">${pos.name}</div>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-darkMuted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                <div class="font-semibold">${fmt(pos.amount, 4)}</div>
              </div>
              <div>
                <div class="text-darkMuted">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
                <div class="font-semibold">${fmt(pos.avgPrice)}</div>
              </div>
              <div>
                <div class="text-darkMuted">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</div>
                <div class="font-semibold">${fmt(pos.currentPrice)}</div>
              </div>
              <div>
                <div class="text-darkMuted">P/L</div>
                <div class="font-semibold ${pnl>=0?'text-emerald-400':'text-red-400'}">
                  ${fmt(pnl)} (${fmt(pnlPercent)}%)
                </div>
              </div>
            </div>
            <button class="px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white mt-2 w-full" onclick="sellCrypto('${pos.id}')">–ü—Ä–æ–¥–∞—Ç—å</button>
          </div>
        `;
      }).join("");

      return `
        <div class="space-y-5">
          <div class="card p-5">
            <h3 class="font-semibold text-lg mb-4">–ê–∫—Ü–∏–∏</h3>
            ${stockRows || "–ù–µ—Ç –∞–∫—Ü–∏–π –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ"}
          </div>

          <div class="card p-5">
            <h3 class="font-semibold text-lg mb-4">–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞</h3>
            ${cryptoRows || "–ù–µ—Ç –∫—Ä–∏–ø—Ç—ã –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ"}
          </div>
        </div>
      `;
    }

    async function sellStock(id){
      try {
        const res = await api.post(`/stocks/sell`, {companyId: id});
        state.economy.balance = res.balance;
        toast("–ü—Ä–æ–¥–∞–Ω–æ");
        updateHeader();
        renderInvestments();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function sellCrypto(id){
      try {
        const res = await api.post(`/cryptos/sell`, {cryptoId: id});
        state.economy.balance = res.balance;
        toast("–ü—Ä–æ–¥–∞–Ω–æ");
        updateHeader();
        renderInvestments();
      } catch (e) {
        toast(e.message, "error");
      }
    }

    /*********************
     * Profile
     *********************/
    async function renderProfile() {
      const user = state.user; // Already fetched
      const adminPanel = state.isAdmin ? `
        <div class="card p-5 mt-4">
          <h3 class="font-semibold mb-4">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
          <div class="flex items-center gap-2">
            <input id="ban_username" class="flex-1 bg-darkBgLight border border-darkBorder rounded-xl px-4 py-3" placeholder="Username –¥–ª—è –±–∞–Ω–∞">
            <button class="px-4 py-3 rounded-xl bg-red-600 text-white" onclick="banUser()">
              –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
      ` : '';

      $content().innerHTML = `
        <section class="space-y-6">
          <div class="card p-5">
            <div class="flex items-center gap-4 mb-4">
              <img src="${user.avatar}" class="w-16 h-16 rounded-full border-2 border-darkPrimary">
              <div>
                <h2 class="font-bold text-xl">${escapeHtml(user.name)}</h2>
                <p class="text-sm text-darkMuted">@${user.username}</p>
              </div>
            </div>
            <p class="text-sm mb-4">${escapeHtml(user.bio)}</p>
          </div>

          <div class="card p-5">
            <h3 class="font-semibold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span>–¢–µ–º–∞</span>
                <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder flex items-center" onclick="toggleTheme()">
                  <i class="fa-solid fa-${state.theme === 'dark' ? 'moon' : 'sun'} mr-2"></i>${state.theme === 'dark' ? '–¢—ë–º–Ω–∞—è' : '–°–≤–µ—Ç–ª–∞—è'}
                </button>
              </div>
              <div class="flex items-center justify-between">
                <span>–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å username –≤ –î–∏–Ω–æ–ù–µ—Ç</span>
                <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowInDinoNet()">
                  ${user.showInDinoNet ? '–î–∞' : '–ù–µ—Ç'}
                </button>
              </div>
              <div class="flex items-center justify-between">
                <span>–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å username –≤ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö</span>
                <button class="px-4 py-2 rounded-xl bg-darkBgLight border border-darkBorder" onclick="toggleShowInInvest()">
                  ${user.hideInInvest ? '–î–∞' : '–ù–µ—Ç'}
                </button>
              </div>
              <div class="flex items-center justify-between">
                <span>–£—Ä–æ–≤–µ–Ω—å</span>
                <span class="font-bold">${state.economy.level}</span>
              </div>
              <div class="flex items-center justify-between">
                <span>XP</span>
                <span class="font-bold">${fmt(state.economy.xp)} / ${state.economy.xpNext}</span>
              </div>
            </div>
          </div>
          ${adminPanel}
        </section>
      `;
    }

    async function toggleShowInDinoNet() {
      state.user.showInDinoNet = !state.user.showInDinoNet;
      await api.post('/user/update', {showInDinoNet: state.user.showInDinoNet});
      renderProfile();
    }

    async function toggleShowInInvest() {
      state.user.hideInInvest = !state.user.hideInInvest;
      await api.post('/user/update', {hideInInvest: state.user.hideInInvest});
      renderProfile();
    }

    async function banUser() {
      const username = document.getElementById('ban_username').value.trim();
      if (!username) return toast("–í–≤–µ–¥–∏—Ç–µ username", "error");
      try {
        await api.post('/admin/ban', {username});
        toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
      } catch (e) {
        toast(e.message, "error");
      }
    }

    async function openProfile(userId) {
      try {
        const user = await getUser(userId);
        const usernameHTML = user.showInDinoNet ? `@${user.username}` : '';
        openModal(`
          <div class="space-y-4">
            <div class="flex items-center gap-4 mb-4">
              <img src="${user.avatar}" class="w-16 h-16 rounded-full border-2 border-darkPrimary">
              <div>
                <h2 class="font-bold text-xl">${escapeHtml(user.name)}</h2>
                <p class="text-sm text-darkMuted">${usernameHTML}</p>
              </div>
            </div>
            <p class="text-sm mb-4">${escapeHtml(user.bio)}</p>
          </div>
        `);
      } catch (e) {
        toast(e.message, "error");
      }
    }

    /*********************
     * Init
     *********************/
    async function init() {
      loadLocal();
      document.body.classList.add(state.theme);
      document.querySelectorAll("[data-tab]").forEach(b => b.addEventListener("click", (e)=>setTab(e.currentTarget.dataset.tab)));

      const tg = Telegram.WebApp;
      tg.ready();
      const tgUser = tg.initDataUnsafe.user;
      const startParam = tg.initDataUnsafe.start_param || '';

      try {
        // Authenticate and get token
        const authRes = await fetch(API_BASE + '/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ initData: window.Telegram.WebApp.initData })
        });
        if (!authRes.ok) throw new Error(await authRes.text());
        const { token } = await authRes.json();
        localStorage.setItem(TOKEN_KEY, token);

        state.user = await api.get('/me');
        if (tgUser) {
          await api.post('/user/update-tg', {tgData: tgUser});
          state.user = await api.get('/me');
        }
        state.isAdmin = state.user.isAdmin; // Now from server
        state.economy = await api.get('/economy');
        updateHeader();
        updateLevel();
      } catch (e) {
        toast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
        return;
      }

      if (startParam.startsWith('ref-game-') && !state.referred) {
        const refId = startParam.slice(9);
        try {
          await api.post('/referrals/join', {referrerId: refId});
          state.referred = true;
          saveLocal();
          toast('–ë–æ–Ω—É—Å –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –ø–æ–ª—É—á–µ–Ω!');
        } catch {}
      } else if (startParam.startsWith('ref-')) {
        if (startParam.startsWith('ref-coin-')) {
          const id = startParam.slice(9);
          setTab('investments');
          invTab = 'crypto';
          await renderInvestments();
          openCryptoDetails(id);
        } else {
          const id = startParam.slice(4);
          setTab('investments');
          invTab = 'stocks';
          await renderInvestments();
          openCompanyDetails(id);
        }
      }

      setTab(state.currentTab);
      tick();
      setInterval(() => state.timeInGame++, 1000);
      setInterval(() => {
        if (Math.random() < 0.05) showInviteModal();
        if (Math.random() < 0.05) showSubscribeModal();
      }, 300000);
    }

    init();
  </script>
</body>
</html>
